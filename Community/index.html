<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社区聊天 - Cait-Lab</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        body {
            background-color: #f5f7fa;
            padding: 20px;
        }

        /* 聊天容器整体样式 */
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* 聊天头部（标题+用户信息） */
        .chat-header {
            padding: 15px 20px;
            background-color: #0078d4;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 18px;
            font-weight: 500;
        }

        .user-info {
            font-size: 14px;
        }

        .user-info span {
            font-weight: bold;
        }

        /* 聊天消息列表 */
        .chat-messages {
            height: 500px;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        /* 单个消息样式 */
        .message-item {
            margin-bottom: 15px;
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }

        /* 自己发送的消息（标蓝、靠右） */
        .message-item.self {
            margin-left: auto;
            align-items: flex-end;
        }

        .message-item.self .content {
            background-color: #0078d4; /* 标蓝 */
            color: #fff; /* 白色文字 */
            border-top-right-radius: 0;
        }

        /* 他人发送的消息（标白、靠左） */
        .message-item.other {
            margin-right: auto;
            align-items: flex-start;
        }

        .message-item.other .content {
            background-color: #fff; /* 标白 */
            color: #333; /* 黑色文字 */
            border: 1px solid #eee;
            border-top-left-radius: 0;
        }

        .message-item .sender {
            font-size: 12px;
            margin-bottom: 4px;
            padding: 0 8px;
        }

        .message-item.self .sender {
            color: #0078d4;
            text-align: right;
        }

        .message-item.other .sender {
            color: #666;
            text-align: left;
        }

        .message-item .content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
            word-wrap: break-word;
        }

        /* 消息输入区域 */
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            resize: none;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            outline: none;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            border-color: #0078d4;
        }

        #sendMsgBtn {
            padding: 12px 25px;
            background-color: #0078d4;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        #sendMsgBtn:hover {
            background-color: #005a9e;
        }

        #sendMsgBtn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        /* 加载提示 */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        /* 滚动条样式优化 */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- 聊天头部：标题 + 登录用户信息 -->
        <div class="chat-header">
            <h3>Cait-Lab 社区聊天</h3>
            <div class="user-info">
                当前登录：<span id="loginNickname">加载中...</span>
            </div>
        </div>

        <!-- 聊天消息展示区域 -->
        <div class="chat-messages" id="chatMessages">
            <div class="loading">正在加载历史消息...</div>
        </div>

        <!-- 消息输入和发送区域 -->
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    placeholder="请输入聊天内容，按回车可快速发送..."
                    spellcheck="false"
                ></textarea>
                <button id="sendMsgBtn">发送</button>
            </div>
        </div>
    </div>

    <script>
        // ========== GitHub API 配置（和登录页保持一致） ==========
        const a_token = 'ghp_';
        const b_token = 'sp39r4hPD5KJDtPLUJyV9jIW5wcwcc0HVRF7';
        const GITHUB_TOKEN = a_token + b_token;
        const OWNER = 'pu-94';
        const REPO = 'Cait-Lab';
        const BASE_URL = 'https://api.github.com';
        const CHAT_CONTENT_PATH = 'Community/Content.txt'; // 聊天内容存储路径
        const DEBUG = true;

        // ========== 核心变量定义 ==========
        const loginNicknameEl = document.getElementById('loginNickname');
        const messageInputEl = document.getElementById('messageInput');
        const sendMsgBtnEl = document.getElementById('sendMsgBtn');
        const chatMessagesEl = document.getElementById('chatMessages');
        
        // 当前登录用户信息
        let currentUser = null;
        let loginUsername = ''; // 用户名（用于匹配消息发送者）
        let loginNickname = ''; // 昵称（用于展示）

        // ========== 工具函数（复用登录页逻辑） ==========
        // 调试输出
        function logDebug(message, data = null) {
            if (DEBUG) {
                console.log(`[DEBUG] ${message}`, data ? data : '');
            }
        }

        // 检查文件是否存在
        async function checkFileExists(path) {
            logDebug(`检查文件是否存在: ${path}`);
            try {
                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                return response.status === 200;
            } catch (error) {
                logDebug(`检查文件错误: ${error.message}`);
                return false;
            }
        }

        // 读取文件内容
        async function readFile(path) {
            logDebug(`读取文件: ${path}`);
            try {
                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) return null;
                    throw new Error(`HTTP ${response.status}: 读取文件失败`);
                }

                const data = await response.json();
                const content = atob(data.content.replace(/\n/g, ''));
                logDebug(`文件内容`, { path, content });
                return {
                    content: content,
                    sha: data.sha // 用于更新文件
                };
            } catch (error) {
                logDebug(`读取文件错误: ${error.message}`);
                throw error;
            }
        }

        // 创建/更新文件
        async function writeFile(path, content, commitMessage, sha = null) {
            logDebug(`写入文件: ${path}`, { message: commitMessage, hasSha: !!sha });
            try {
                const requestBody = {
                    message: commitMessage,
                    content: btoa(content) // 转base64
                };
                // 更新文件需要传入sha值
                if (sha) requestBody.sha = sha;

                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseData = await response.json();
                logDebug(`写入文件响应`, { status: response.status, data: responseData });

                if (!response.ok) {
                    throw new Error(responseData.message || `HTTP ${response.status}: 写入文件失败`);
                }

                return responseData;
            } catch (error) {
                logDebug(`写入文件错误: ${error.message}`);
                throw error;
            }
        }

        // ========== 聊天核心逻辑 ==========
        // 初始化
        async function init() {
            try {
                // 1. 读取登录用户信息
                const userStr = localStorage.getItem('caitlab_currentUser');
                if (!userStr) {
                    throw new Error('未找到登录信息');
                }
                currentUser = JSON.parse(userStr);
                loginUsername = currentUser.username; // 核心：用用户名匹配消息发送者
                loginNickname = currentUser.nickname || currentUser.username;
                loginNicknameEl.textContent = loginNickname;

                // 2. 加载历史消息
                await loadChatHistory();

                // 3. 绑定事件
                bindEvent();

            } catch (err) {
                loginNicknameEl.textContent = '未登录';
                sendMsgBtnEl.disabled = true;
                chatMessagesEl.innerHTML = `<div class="loading" style="color: #dc3545;">${err.message}，请重新登录！</div>`;
                alert(`登录状态异常：${err.message}`);
                setTimeout(() => {
                    window.location.href = '../auth/login/index.html';
                }, 1000);
            }
        }

        // 绑定事件
        function bindEvent() {
            // 点击发送按钮
            sendMsgBtnEl.addEventListener('click', sendMessage);
            // 回车发送（shift+回车换行）
            messageInputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // 加载历史聊天记录
        async function loadChatHistory() {
            try {
                // 检查文件是否存在
                const fileExists = await checkFileExists(CHAT_CONTENT_PATH);
                if (!fileExists) {
                    chatMessagesEl.innerHTML = ''; // 无历史消息，清空加载提示
                    return;
                }

                // 读取文件内容
                const fileData = await readFile(CHAT_CONTENT_PATH);
                if (!fileData || !fileData.content) {
                    chatMessagesEl.innerHTML = '';
                    return;
                }

                // 解析消息（按行分割，格式：用户名:内容）
                const messages = fileData.content.split('\n').filter(line => line.trim());
                renderMessages(messages);

            } catch (error) {
                logDebug(`加载历史消息错误: ${error.message}`);
                chatMessagesEl.innerHTML = `<div class="loading" style="color: #dc3545;">加载失败：${error.message}</div>`;
            }
        }

        // 渲染消息到页面
        function renderMessages(messages) {
            chatMessagesEl.innerHTML = ''; // 清空容器

            messages.forEach(msgLine => {
                // 分割用户名和内容（只分割第一个冒号，避免内容含冒号）
                const colonIndex = msgLine.indexOf(':');
                if (colonIndex === -1) return; // 格式错误，跳过

                const senderUsername = msgLine.substring(0, colonIndex).trim();
                const msgContent = msgLine.substring(colonIndex + 1).trim();
                if (!senderUsername || !msgContent) return;

                // 判断是否是自己的消息
                const isSelf = senderUsername === loginUsername;
                // 获取展示用的昵称（自己用登录昵称，他人暂时用用户名，可扩展）
                const displayName = isSelf ? loginNickname : senderUsername;

                // 创建消息DOM
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${isSelf ? 'self' : 'other'}`;
                messageItem.innerHTML = `
                    <div class="sender">${displayName}</div>
                    <div class="content">${msgContent.replace(/\n/g, '<br>')}</div>
                `;
                chatMessagesEl.appendChild(messageItem);
            });

            // 滚动到底部
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // 发送消息核心逻辑
        async function sendMessage() {
            // 1. 校验输入
            const messageContent = messageInputEl.value.trim();
            if (!messageContent) {
                alert('消息内容不能为空！');
                return;
            }
            sendMsgBtnEl.disabled = true;

            try {
                // 2. 构建新消息行（格式：用户名:内容）
                const newMsgLine = `${loginUsername}:${messageContent}`;

                // 3. 读取现有内容（用于追加）
                let existingContent = '';
                let fileSha = null;
                const fileExists = await checkFileExists(CHAT_CONTENT_PATH);
                
                if (fileExists) {
                    const fileData = await readFile(CHAT_CONTENT_PATH);
                    existingContent = fileData.content || '';
                    fileSha = fileData.sha;
                }

                // 4. 追加新消息（换行分隔）
                const newContent = existingContent 
                    ? `${existingContent}\n${newMsgLine}` 
                    : newMsgLine;

                // 5. 写入GitHub仓库
                await writeFile(
                    CHAT_CONTENT_PATH,
                    newContent,
                    `Chat message from ${loginUsername}`,
                    fileSha
                );

                // 6. 清空输入框，重新加载消息
                messageInputEl.value = '';
                await loadChatHistory();

            } catch (error) {
                logDebug(`发送消息错误: ${error.message}`);
                alert(`发送失败：${error.message}`);
            } finally {
                sendMsgBtnEl.disabled = false;
            }
        }

        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>
