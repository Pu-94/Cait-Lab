<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社区聊天界面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 10px;
            background-color: #f5f5f5;
        }
        /* 聊天记录区域 */
        .chat-container {
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #f0f8ff;
            line-height: 1.5;
        }
        /* 输入区域 */
        .input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #username {
            width: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #message {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: none;
            height: 60px;
        }
        #sendBtn {
            width: 80px;
            height: 60px;
            background-color: #0084ff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #sendBtn:hover {
            background-color: #0066cc;
        }
        .error {
            color: red;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chatContainer"></div>
    <div class="input-area">
        <input type="text" id="username" placeholder="请输入用户名" required>
        <textarea id="message" placeholder="请输入聊天内容..." required></textarea>
        <button id="sendBtn">发送</button>
    </div>
    <div class="error" id="errorTip"></div>

    <script>
        // -------------------------- 配置项（统一Token配置，移除中文占位符） --------------------------
        const OWNER = "Pu-94"; // 仓库所有者
        const REPO = "Cait-Lab"; // 仓库名
        const BRANCH = "Community"; // 指定分支名
        const FILE_PATH = "Content.txt"; // 聊天记录文件路径
        // 统一声明Token（拆分写法，无中文字符）
        const TOKEN_PREFIX = 'ghp_';
        const TOKEN_SUFFIX = 'sp39r4hPD5KJDtPLUJyV9jIW5wcwcc0HVRF7'; // 你的Token后半段
        const GITHUB_TOKEN = TOKEN_PREFIX + TOKEN_SUFFIX; // 拼接成完整Token
        // 违规关键词列表（可自行扩展）
        const ILLEGAL_WORDS = ["违规词1", "违规词2", "敏感词1", "敏感词2"];

        // -------------------------- 核心功能函数 --------------------------
        // 1. 加载并显示聊天记录（使用正确的Token）
        async function loadChatRecords() {
            const chatContainer = document.getElementById("chatContainer");
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`,
                    {
                        headers: {
                            // 使用无中文字符的完整Token
                            Authorization: `token ${GITHUB_TOKEN}`,
                            Accept: "application/vnd.github.v3+json"
                        }
                    }
                );

                if (!response.ok) {
                    if (response.status === 404) {
                        chatContainer.innerHTML = "<div class='chat-message'>暂无聊天记录，发送第一条消息吧！</div>";
                        return;
                    }
                    throw new Error(`获取记录失败：${response.statusText}`);
                }

                const data = await response.json();
                const content = atob(data.content);
                const messages = content.split("\n").filter(line => line.trim() !== "");
                chatContainer.innerHTML = messages.length > 0 
                    ? messages.map(msg => `<div class="chat-message">${msg}</div>`).join("")
                    : "<div class='chat-message'>暂无聊天记录，发送第一条消息吧！</div>";
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } catch (error) {
                document.getElementById("errorTip").textContent = `加载失败：${error.message}`;
                console.error(error);
            }
        }

        // 2. 违规内容检测
        function checkIllegalContent(content) {
            return ILLEGAL_WORDS.some(word => content.includes(word));
        }

        // 3. 发送消息（统一使用正确的Token）
        async function sendMessage() {
            const username = document.getElementById("username").value.trim();
            const message = document.getElementById("message").value.trim();
            const errorTip = document.getElementById("errorTip");
            errorTip.textContent = "";

            if (!username) {
                errorTip.textContent = "请输入用户名！";
                return;
            }
            if (!message) {
                errorTip.textContent = "请输入聊天内容！";
                return;
            }
            if (checkIllegalContent(message)) {
                errorTip.textContent = "消息包含违规内容，无法发送！";
                return;
            }

            try {
                // 第一步：获取文件SHA值（使用正确Token）
                const getResponse = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`,
                    {
                        headers: {
                            Authorization: `token ${GITHUB_TOKEN}`,
                            Accept: "application/vnd.github.v3+json"
                        }
                    }
                );

                let sha = "";
                let oldContent = "";
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                    oldContent = atob(data.content);
                } else if (getResponse.status !== 404) {
                    throw new Error(`获取文件信息失败：${getResponse.statusText}`);
                }

                // 第二步：拼接新内容
                const newContent = `${oldContent}${oldContent ? "\n" : ""}${username}:${message}`;
                const encodedContent = btoa(unescape(encodeURIComponent(newContent)));

                // 第三步：更新文件（使用正确Token）
                const putResponse = await fetch(
                    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,
                    {
                        method: "PUT",
                        headers: {
                            Authorization: `token ${GITHUB_TOKEN}`,
                            Accept: "application/vnd.github.v3+json",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            message: `Add chat message from ${username}`,
                            content: encodedContent,
                            sha: sha,
                            branch: BRANCH
                        })
                    }
                );

                if (!putResponse.ok) {
                    throw new Error(`发送失败：${putResponse.statusText}`);
                }

                document.getElementById("message").value = "";
                await loadChatRecords();
            } catch (error) {
                errorTip.textContent = `发送失败：${error.message}`;
                console.error(error);
            }
        }

        // -------------------------- 初始化 --------------------------
        window.onload = loadChatRecords;
        document.getElementById("sendBtn").addEventListener("click", sendMessage);
        document.getElementById("message").addEventListener("keydown", (e) => {
            if (e.ctrlKey && e.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>
</html>
