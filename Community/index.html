<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åŒºèŠå¤© - Cait-Lab</title>
    <style>
        /* æ ·å¼å’Œä¹‹å‰å®Œå…¨ä¸€è‡´ï¼Œæ— éœ€ä¿®æ”¹ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        body {
            background-color: #f5f7fa;
            padding: 20px;
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-header {
            padding: 15px 20px;
            background-color: #0078d4;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 18px;
            font-weight: 500;
        }

        .user-info {
            font-size: 14px;
        }

        .user-info span {
            font-weight: bold;
        }

        .chat-messages {
            height: 500px;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        .message-item {
            margin-bottom: 15px;
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }

        .message-item.self {
            margin-left: auto;
            align-items: flex-end;
        }

        .message-item.self .content {
            background-color: #0078d4;
            color: #fff;
            border-top-right-radius: 0;
        }

        .message-item.other {
            margin-right: auto;
            align-items: flex-start;
        }

        .message-item.other .content {
            background-color: #fff;
            color: #333;
            border: 1px solid #eee;
            border-top-left-radius: 0;
        }

        .message-item .sender {
            font-size: 12px;
            margin-bottom: 4px;
            padding: 0 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message-item.self .sender {
            color: #0078d4;
            text-align: right;
            justify-content: flex-end;
        }

        .message-item.other .sender {
            color: #666;
            text-align: left;
        }

        .level-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .admin-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 4px;
        }

        .message-item .time {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
            padding: 0 8px;
        }

        .message-item.self .time {
            text-align: right;
        }

        .message-item.other .time {
            text-align: left;
        }

        .message-item .content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
            word-wrap: break-word;
        }

        .system-message {
            text-align: center;
            margin: 8px 0;
            font-size: 12px;
            color: #666;
            background: #f1f1f1;
            padding: 4px 12px;
            border-radius: 10px;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .command-list {
            text-align: left;
            font-size: 12px;
            line-height: 1.6;
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            resize: none;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            outline: none;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            border-color: #0078d4;
        }

        #sendMsgBtn {
            padding: 12px 25px;
            background-color: #0078d4;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        #sendMsgBtn:hover {
            background-color: #005a9e;
        }

        #sendMsgBtn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h3>Cait-Lab ç¤¾åŒºèŠå¤©</h3>
            <div class="user-info">
                å½“å‰ç™»å½•ï¼š<span id="loginNickname">åŠ è½½ä¸­...</span>
                <span id="loginLevel" class="level-badge" style="margin-left: 5px; font-size: 10px;"></span>
                <span id="loginAdminBadge" class="admin-badge" style="display: none;">ç®¡ç†å‘˜</span>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="loading">æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...</div>
        </div>
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    placeholder="è¯·è¾“å…¥èŠå¤©å†…å®¹"
                    spellcheck="false"
                ></textarea>
                <button id="sendMsgBtn">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        // ========== é…ç½®ä¸å˜ ==========
        const a_token = 'ghp_';
        const b_token = 'sp39r4hPD5KJDtPLUJyV9jIW5wcwcc0HVRF7';
        const GITHUB_TOKEN = a_token + b_token;
        const OWNER = 'pu-94';
        const REPO = 'Cait-Lab';
        const BASE_URL = 'https://api.github.com';
        const CHAT_CONTENT_PATH = 'Community/Content.txt';
        const ADMIN_FILE_PATH = 'Community/Admin.txt';
        const SUPER_ADMIN_USERNAME = 'Pu_cait';
        const DEBUG = true;

        // ========== æ–°å¢ï¼šå…¨å±€ç¼“å­˜ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰ ==========
        const cache = {
            userInfo: {}, // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼š{username: {nickname, level, isAdmin}}
            adminList: [], // ç¼“å­˜ç®¡ç†å‘˜åˆ—è¡¨
            chatHistory: [], // ç¼“å­˜èŠå¤©è®°å½•
            chatSha: '' // ç¼“å­˜èŠå¤©æ–‡ä»¶çš„shaï¼Œé¿å…é‡å¤è¯·æ±‚
        };

        // ========== å…ƒç´ è·å–ä¸å˜ ==========
        const loginNicknameEl = document.getElementById('loginNickname');
        const loginLevelEl = document.getElementById('loginLevel');
        const loginAdminBadgeEl = document.getElementById('loginAdminBadge');
        const messageInputEl = document.getElementById('messageInput');
        const sendMsgBtnEl = document.getElementById('sendMsgBtn');
        const chatMessagesEl = document.getElementById('chatMessages');

        let currentUser = null;
        let loginUsername = '';
        let loginNickname = '';
        let loginLevel = '';
        let isAdmin = false;

        // ========== å·¥å…·å‡½æ•°ï¼ˆå°‘é‡ä¿®æ”¹ï¼Œå¢åŠ ç¼“å­˜åˆ¤æ–­ï¼‰ ==========
        function logDebug(message, data = null) {
            if (DEBUG) console.log(`[DEBUG] ${message}`, data ? data : '');
        }

        function formatTime(timestamp) {
            const date = new Date(Number(timestamp));
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,0)}-${date.getDate().toString().padStart(2,0)} ${date.getHours().toString().padStart(2,0)}:${date.getMinutes().toString().padStart(2,0)}:${date.getSeconds().toString().padStart(2,0)}`;
        }

        async function checkFileExists(path) {
            try {
                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                return response.status === 200;
            } catch (error) {
                logDebug(`æ£€æŸ¥æ–‡ä»¶é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        async function readFile(path) {
            try {
                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (!response.ok) return response.status === 404 ? null : Promise.reject(new Error(`HTTP ${response.status}`));
                const data = await response.json();
                return { content: atob(data.content.replace(/\n/g, '')), sha: data.sha };
            } catch (error) {
                logDebug(`è¯»å–æ–‡ä»¶é”™è¯¯: ${error.message}`);
                throw error;
            }
        }

        async function writeFile(path, content, commitMessage, sha = null) {
            try {
                const requestBody = { message: commitMessage, content: btoa(content) };
                if (sha) requestBody.sha = sha;
                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || `HTTP ${response.status}`);
                return data;
            } catch (error) {
                logDebug(`å†™å…¥æ–‡ä»¶é”™è¯¯: ${error.message}`);
                throw error;
            }
        }

        async function deleteFile(path, commitMessage, sha) {
            try {
                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: commitMessage, sha: sha })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || `HTTP ${response.status}`);
                return data;
            } catch (error) {
                logDebug(`åˆ é™¤æ–‡ä»¶é”™è¯¯: ${error.message}`);
                throw error;
            }
        }

        // ========== ç®¡ç†å‘˜é€»è¾‘ï¼ˆä¿®æ”¹ï¼šå¢åŠ ç¼“å­˜ï¼‰ ==========
        async function getAdminList() {
            // æœ‰ç¼“å­˜ç›´æ¥è¿”å›ï¼Œä¸é‡å¤è¯·æ±‚
            if (cache.adminList.length > 0) return cache.adminList;
            logDebug(`é¦–æ¬¡è¯»å–ç®¡ç†å‘˜åˆ—è¡¨`);
            try {
                const fileExists = await checkFileExists(ADMIN_FILE_PATH);
                let adminList = fileExists ? (await readFile(ADMIN_FILE_PATH)).content.split('\n').map(a => a.trim()).filter(a => a) : [];
                if (!adminList.includes(SUPER_ADMIN_USERNAME)) adminList.push(SUPER_ADMIN_USERNAME);
                cache.adminList = adminList; // å­˜å…¥ç¼“å­˜
                return adminList;
            } catch (error) {
                logDebug(`è¯»å–ç®¡ç†å‘˜åˆ—è¡¨å¤±è´¥: ${error.message}`);
                cache.adminList = [SUPER_ADMIN_USERNAME];
                return cache.adminList;
            }
        }

        async function checkIsAdmin(username) {
            const adminList = await getAdminList();
            return adminList.includes(username);
        }

        async function addAdmin(targetUsername) {
            logDebug(`æ·»åŠ ç®¡ç†å‘˜: ${targetUsername}`);
            try {
                if (!await checkFileExists(`users/${targetUsername}/Nickname.txt`)) return { success: false, message: `ç”¨æˆ·ä¸å­˜åœ¨ï¼š${targetUsername}` };
                if (await checkIsAdmin(targetUsername)) return { success: false, message: `${targetUsername} å·²æ˜¯ç®¡ç†å‘˜` };
                const adminList = await getAdminList();
                adminList.push(targetUsername);
                const uniqueAdminList = [...new Set(adminList)];
                const fileExists = await checkFileExists(ADMIN_FILE_PATH);
                await writeFile(ADMIN_FILE_PATH, uniqueAdminList.join('\n'), `Add admin: ${targetUsername} by ${loginUsername}`, fileExists ? (await readFile(ADMIN_FILE_PATH)).sha : null);
                cache.adminList = uniqueAdminList; // æ›´æ–°ç¼“å­˜
                return { success: true, message: `âœ… å·²å°† ${targetUsername} è®¾ç½®ä¸ºç®¡ç†å‘˜` };
            } catch (error) {
                logDebug(`æ·»åŠ ç®¡ç†å‘˜å¤±è´¥: ${error.message}`);
                return { success: false, message: `æ·»åŠ å¤±è´¥ï¼š${error.message}` };
            }
        }

        // ========== ç”¨æˆ·ä¿¡æ¯ï¼ˆä¿®æ”¹ï¼šå¢åŠ ç¼“å­˜ï¼Œæ ¸å¿ƒä¼˜åŒ–ï¼‰ ==========
        async function getUserNicknameAndLevel(username) {
            // æœ‰ç¼“å­˜ç›´æ¥è¿”å›ï¼Œä¸é‡å¤è¯·æ±‚API
            if (cache.userInfo[username]) return cache.userInfo[username];
            logDebug(`é¦–æ¬¡è·å–ç”¨æˆ·ä¿¡æ¯: ${username}`);
            try {
                const nicknameFile = await readFile(`users/${username}/Nickname.txt`);
                const levelFile = await readFile(`users/${username}/Level.txt`);
                const nickname = nicknameFile ? nicknameFile.content.trim() || username : username;
                const level = levelFile ? levelFile.content.trim() || '1' : '1';
                const isAdmin = await checkIsAdmin(username);
                const userInfo = { nickname, level, isAdmin };
                cache.userInfo[username] = userInfo; // å­˜å…¥ç¼“å­˜
                return userInfo;
            } catch (error) {
                logDebug(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`);
                const userInfo = { nickname: username, level: '1', isAdmin: false };
                cache.userInfo[username] = userInfo;
                return userInfo;
            }
        }

        // ========== æŒ‡ä»¤é€»è¾‘ï¼ˆå®Œå…¨ä¸å˜ï¼‰ ==========
        const commandList = [
            { full: '/Help', short: '/H', desc: 'æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„æŒ‡ä»¤' },
            { full: '/Refresh', short: '/Rfr', desc: 'åˆ·æ–°èŠå¤©è®°å½•ï¼ˆæ‰€æœ‰äººå¯ç”¨ï¼‰' },
            { full: '/clean', short: '/cls', desc: 'æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰' },
            { full: '/new_Administrator <ç”¨æˆ·å>', short: '/new_Admin <ç”¨æˆ·å>', desc: 'è®¾ç½®ç®¡ç†å‘˜ï¼ˆä»…Pu_caitå¯ç”¨ï¼‰' }
        ];

        async function parseCommand(commandStr) {
            const cmd = commandStr.trim().toLowerCase();
            let feedback = '';
            if (cmd === '/help' || cmd === '/h') {
                const commandHtml = commandList.map(item => `<div>â€¢ ${item.full} (${item.short})ï¼š${item.desc}</div>`).join('');
                addSystemMessage(`<div>ğŸ“‹ æ”¯æŒçš„æŒ‡ä»¤åˆ—è¡¨ï¼š</div><div class="command-list">${commandHtml}</div>`);
                return;
            }
            if (cmd === '/refresh' || cmd === '/rfr') {
                await loadChatHistory(true); // å¼ºåˆ¶åˆ·æ–°è¿œç¨‹
                feedback = 'âœ… èŠå¤©è®°å½•å·²åˆ·æ–°';
            } else if (cmd === '/clean' || cmd === '/cls') {
                if (!isAdmin && loginUsername !== SUPER_ADMIN_USERNAME) {
                    feedback = 'âŒ æƒé™ä¸è¶³ï¼šä»…ç®¡ç†å‘˜å¯æ‰§è¡Œæ¸…ç©ºæ“ä½œ';
                } else {
                    if (!cache.chatHistory.length) {
                        feedback = 'â„¹ï¸ èŠå¤©è®°å½•ä¸ºç©ºï¼Œæ— éœ€æ¸…ç©º';
                    } else {
                        await deleteFile(CHAT_CONTENT_PATH, `Clear chat by ${loginUsername}`, cache.chatSha);
                        cache.chatHistory = []; // æ¸…ç©ºç¼“å­˜
                        cache.chatSha = '';
                        await loadChatHistory(true);
                        feedback = 'ğŸ—‘ï¸ èŠå¤©è®°å½•å·²æ¸…ç©º';
                    }
                }
            } else if (cmd.startsWith('/new_administrator') || cmd.startsWith('/new_admin')) {
                if (loginUsername !== SUPER_ADMIN_USERNAME) {
                    feedback = 'âŒ æƒé™ä¸è¶³ï¼šä»…Pu_caitå¯è®¾ç½®ç®¡ç†å‘˜';
                } else {
                    const parts = commandStr.trim().split(' ');
                    if (parts.length < 2) {
                        feedback = 'âŒ æŒ‡ä»¤æ ¼å¼é”™è¯¯ï¼š/new_Admin <ç”¨æˆ·å>';
                    } else {
                        const result = await addAdmin(parts[1].trim());
                        feedback = result.message;
                    }
                }
            } else {
                feedback = `âŒ æœªçŸ¥æŒ‡ä»¤ï¼š${commandStr}ï¼ˆè¾“å…¥/HelpæŸ¥çœ‹æ‰€æœ‰æŒ‡ä»¤ï¼‰`;
            }
            addSystemMessage(feedback);
        }

        function addSystemMessage(content) {
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.innerHTML = content;
            chatMessagesEl.appendChild(systemMsg);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // ========== èŠå¤©æ ¸å¿ƒé€»è¾‘ï¼ˆé‡å†™ï¼šç¼“å­˜+å¼‚æ­¥æ¸²æŸ“ï¼Œæ ¸å¿ƒä¼˜åŒ–ï¼‰ ==========
        async function init() {
            try {
                const userStr = localStorage.getItem('caitlab_currentUser');
                if (!userStr) throw new Error('æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯');
                currentUser = JSON.parse(userStr);
                loginUsername = currentUser.username;
                loginNickname = currentUser.nickname || currentUser.username;
                loginLevel = currentUser.level || '1';
                isAdmin = await checkIsAdmin(loginUsername);
                // ç¼“å­˜å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
                cache.userInfo[loginUsername] = { nickname: loginNickname, level: loginLevel, isAdmin };

                loginNicknameEl.textContent = loginNickname;
                loginLevelEl.textContent = `Lv.${loginLevel}`;
                if (isAdmin) loginAdminBadgeEl.style.display = 'inline-block';

                await loadChatHistory(); // é¦–æ¬¡åŠ è½½
                bindEvent();
            } catch (err) {
                loginNicknameEl.textContent = 'æœªç™»å½•';
                loginLevelEl.style.display = 'none';
                sendMsgBtnEl.disabled = true;
                chatMessagesEl.innerHTML = `<div class="loading" style="color: #dc3545;">${err.message}ï¼Œè¯·é‡æ–°ç™»å½•ï¼</div>`;
                alert(`ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼š${err.message}`);
                setTimeout(() => window.location.href = '../auth/login/index.html', 1000);
            }
        }

        function bindEvent() {
            sendMsgBtnEl.addEventListener('click', sendMessage);
            messageInputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });
        }

        // æ–°å¢å‚æ•°ï¼šisForce - æ˜¯å¦å¼ºåˆ¶åˆ·æ–°è¿œç¨‹ï¼ˆ/RefreshæŒ‡ä»¤æ—¶ç”¨ï¼‰
        async function loadChatHistory(isForce = false) {
            try {
                // 1. æœ‰æœ¬åœ°ç¼“å­˜ä¸”éå¼ºåˆ¶åˆ·æ–° â†’ å…ˆæ¸²æŸ“ç¼“å­˜ï¼Œåå°åŒæ­¥
                if (cache.chatHistory.length > 0 && !isForce) {
                    renderChatHistory(cache.chatHistory);
                    // åå°é™é»˜åŒæ­¥è¿œç¨‹æœ€æ–°è®°å½•
                    syncRemoteChatHistory();
                    return;
                }
                // 2. æ— ç¼“å­˜/å¼ºåˆ¶åˆ·æ–° â†’ ä»è¿œç¨‹è·å–
                chatMessagesEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...</div>';
                await syncRemoteChatHistory();
            } catch (error) {
                logDebug(`åŠ è½½å†å²æ¶ˆæ¯é”™è¯¯: ${error.message}`);
                chatMessagesEl.innerHTML = `<div class="loading" style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼š${error.message}</div>`;
            }
        }

        // åå°åŒæ­¥è¿œç¨‹èŠå¤©è®°å½•ï¼Œå¹¶æ›´æ–°ç¼“å­˜
        async function syncRemoteChatHistory() {
            try {
                const fileExists = await checkFileExists(CHAT_CONTENT_PATH);
                if (!fileExists) {
                    cache.chatHistory = [];
                    cache.chatSha = '';
                    chatMessagesEl.innerHTML = '';
                    return;
                }
                const fileData = await readFile(CHAT_CONTENT_PATH);
                if (!fileData || !fileData.content) {
                    cache.chatHistory = [];
                    cache.chatSha = '';
                    chatMessagesEl.innerHTML = '';
                    return;
                }
                // è§£æå¹¶æ›´æ–°ç¼“å­˜
                const chatHistory = fileData.content.split('\n').filter(line => line.trim());
                cache.chatHistory = chatHistory;
                cache.chatSha = fileData.sha;
                // æ¸²æŸ“æœ€æ–°è®°å½•
                renderChatHistory(chatHistory);
            } catch (error) {
                logDebug(`åŒæ­¥è¿œç¨‹èŠå¤©è®°å½•å¤±è´¥: ${error.message}`);
                addSystemMessage(`âš ï¸ åå°åŒæ­¥å¤±è´¥ï¼Œå±•ç¤ºæœ¬åœ°ç¼“å­˜è®°å½•`);
            }
        }

        // å¼‚æ­¥æ¸²æŸ“èŠå¤©è®°å½•ï¼šè¾¹è·å–ç”¨æˆ·ä¿¡æ¯è¾¹å±•ç¤º
        function renderChatHistory(messages) {
            chatMessagesEl.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
            messages.forEach(async (msgLine) => {
                const firstSplit = msgLine.indexOf('|');
                const secondSplit = msgLine.indexOf(':', firstSplit + 1);
                if (firstSplit === -1 || secondSplit === -1) return;

                const senderUsername = msgLine.substring(0, firstSplit).trim();
                const timestamp = msgLine.substring(firstSplit + 1, secondSplit).trim();
                const msgContent = msgLine.substring(secondSplit + 1).trim();
                if (!senderUsername || !timestamp || !msgContent) return;

                const isSelf = senderUsername === loginUsername;
                // åˆ›å»ºæ¶ˆæ¯DOMï¼Œå…ˆå±•ç¤ºåŸºç¡€å†…å®¹
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${isSelf ? 'self' : 'other'}`;
                messageItem.id = `msg_${senderUsername}_${timestamp}`;
                // ä¸´æ—¶å±•ç¤ºç”¨æˆ·åï¼Œè·å–ä¿¡æ¯åæ›´æ–°
                messageItem.innerHTML = `
                    <div class="sender">${senderUsername}<span class="level-badge">Lv.?</span></div>
                    <div class="content">${msgContent.replace(/\n/g, '<br>')}</div>
                    <div class="time">${formatTime(timestamp)}</div>
                `;
                chatMessagesEl.appendChild(messageItem);

                // å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ›´æ–°DOMï¼ˆä¸é˜»å¡æ¸²æŸ“ï¼‰
                const userInfo = await getUserNicknameAndLevel(senderUsername);
                const adminBadge = userInfo.isAdmin ? '<span class="admin-badge">ç®¡ç†å‘˜</span>' : '';
                messageItem.innerHTML = `
                    <div class="sender">${userInfo.nickname}<span class="level-badge">Lv.${userInfo.level}</span>${adminBadge}</div>
                    <div class="content">${msgContent.replace(/\n/g, '<br>')}</div>
                    <div class="time">${formatTime(timestamp)}</div>
                `;
            });
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        async function sendMessage() {
            const inputContent = messageInputEl.value.trim();
            if (!inputContent) { alert('è¯·è¾“å…¥èŠå¤©å†…å®¹'); return; }
            sendMsgBtnEl.disabled = true;

            try {
                if (inputContent.startsWith('/')) {
                    await parseCommand(inputContent);
                    messageInputEl.value = '';
                    sendMsgBtnEl.disabled = false;
                    return;
                }

                const timestamp = Date.now().toString();
                const newMsgLine = `${loginUsername}|${timestamp}:${inputContent}`;
                let existingContent = '';
                let fileSha = cache.chatSha; // ç”¨ç¼“å­˜çš„shaï¼Œé¿å…é‡å¤è¯·æ±‚

                if (cache.chatHistory.length > 0) {
                    existingContent = cache.chatHistory.join('\n');
                } else if (await checkFileExists(CHAT_CONTENT_PATH)) {
                    const fileData = await readFile(CHAT_CONTENT_PATH);
                    existingContent = fileData.content || '';
                    fileSha = fileData.sha;
                }

                const newContent = existingContent ? `${existingContent}\n${newMsgLine}` : newMsgLine;
                const res = await writeFile(CHAT_CONTENT_PATH, newContent, `Chat message from ${loginUsername}`, fileSha);

                // æ›´æ–°ç¼“å­˜ï¼Œé¿å…é‡æ–°è¯·æ±‚
                cache.chatHistory.push(newMsgLine);
                cache.chatSha = res.sha;
                cache.userInfo[loginUsername] = { nickname: loginNickname, level: loginLevel, isAdmin }; // ç¡®ä¿å½“å‰ç”¨æˆ·ç¼“å­˜æœ€æ–°

                messageInputEl.value = '';
                renderChatHistory(cache.chatHistory); // ç”¨ç¼“å­˜æ¸²æŸ“ï¼Œç§’æ›´
            } catch (error) {
                logDebug(`å‘é€æ¶ˆæ¯é”™è¯¯: ${error.message}`);
                alert(`å‘é€å¤±è´¥ï¼š${error.message}`);
                addSystemMessage(`âŒ å‘é€å¤±è´¥ï¼š${error.message}`);
            } finally {
                sendMsgBtnEl.disabled = false;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
