<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社区聊天 - Cait-Lab</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        body {
            background-color: #f5f7fa;
            padding: 20px;
        }

        /* 聊天容器整体样式 */
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* 聊天头部（标题+用户信息） */
        .chat-header {
            padding: 15px 20px;
            background-color: #0078d4;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 18px;
            font-weight: 500;
        }

        .user-info {
            font-size: 14px;
        }

        .user-info span {
            font-weight: bold;
        }

        /* 聊天消息列表 */
        .chat-messages {
            height: 500px;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        /* 单个消息样式 */
        .message-item {
            margin-bottom: 15px;
            max-width: 70%;
        }

        /* 自己发送的消息 */
        .message-item.self {
            margin-left: auto;
        }

        .message-item .sender {
            font-size: 12px;
            margin-bottom: 4px;
            color: #666;
        }

        .message-item.self .sender {
            text-align: right;
            color: #0078d4;
        }

        .message-item .content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
        }

        .message-item.other .content {
            background-color: #e5e5e5;
            color: #333;
            border-top-left-radius: 0;
        }

        .message-item.self .content {
            background-color: #0078d4;
            color: #fff;
            border-top-right-radius: 0;
        }

        /* 消息输入区域 */
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            resize: none;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            outline: none;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            border-color: #0078d4;
        }

        #sendMsgBtn {
            padding: 12px 25px;
            background-color: #0078d4;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        #sendMsgBtn:hover {
            background-color: #005a9e;
        }

        #sendMsgBtn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        /* 滚动条样式优化 */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- 聊天头部：标题 + 登录用户信息 -->
        <div class="chat-header">
            <h3>Cait-Lab 社区聊天</h3>
            <div class="user-info">
                当前登录：<span id="loginNickname">加载中...</span>
            </div>
        </div>

        <!-- 聊天消息展示区域 -->
        <div class="chat-messages" id="chatMessages"></div>

        <!-- 消息输入和发送区域 -->
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    placeholder="请输入聊天内容，按回车可快速发送..."
                    spellcheck="false"
                ></textarea>
                <button id="sendMsgBtn">发送</button>
            </div>
        </div>
    </div>

    <script>
        // ========== 核心变量定义 ==========
        const loginNicknameEl = document.getElementById('loginNickname');
        const messageInputEl = document.getElementById('messageInput');
        const sendMsgBtnEl = document.getElementById('sendMsgBtn');
        const chatMessagesEl = document.getElementById('chatMessages');
        
        // 从localStorage读取完整用户信息并解析（适配登录页的存储格式）
        let currentUser = null;
        let loginNickname = '';

        // ========== 初始化校验 ==========
        function init() {
            try {
                // 1. 读取登录页存储的用户信息
                const userStr = localStorage.getItem('caitlab_currentUser');
                if (!userStr) {
                    throw new Error('未找到登录信息');
                }

                // 2. 解析JSON字符串为用户对象
                currentUser = JSON.parse(userStr);
                
                // 3. 提取昵称（★ 关键：如果你的用户对象里昵称字段不是nickname，修改这里 ★）
                // 示例：如果是username/name，则改成 currentUser.username / currentUser.name
                loginNickname = currentUser.nickname || currentUser.username || '未知用户';
            } catch (err) {
                // 解析失败/无登录信息的处理
                loginNicknameEl.textContent = '未登录';
                sendMsgBtnEl.disabled = true; // 禁用发送按钮
                alert(`登录状态异常：${err.message}，请重新登录！`);
                
                // 跳转到登录页面（路径匹配你的项目结构）
                setTimeout(() => {
                    window.location.href = '../auth/login/index.html';
                }, 1000);
                return;
            }

            // 登录状态正常：展示昵称，绑定事件
            loginNicknameEl.textContent = loginNickname;
            bindEvent();

            // 模拟一条欢迎消息（可选）
            addMessageToChat('系统', `欢迎 ${loginNickname} 加入聊天！`, 'other');
        }

        // ========== 事件绑定 ==========
        function bindEvent() {
            // 点击发送按钮发送消息
            sendMsgBtnEl.addEventListener('click', sendMessage);

            // 回车发送消息（按住shift+回车换行）
            messageInputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // 阻止默认换行
                    sendMessage();
                }
            });
        }

        // ========== 发送消息核心逻辑 ==========
        function sendMessage() {
            // 1. 获取并清洗消息内容
            const messageContent = messageInputEl.value.trim();
            if (!messageContent) {
                alert('消息内容不能为空！');
                return;
            }

            // 2. 构建消息对象
            const message = {
                sender: loginNickname, // 使用解析后的登录昵称
                content: messageContent,
                time: formatTime(new Date())
            };

            // 3. 展示到聊天窗口（自己的消息）
            addMessageToChat(message.sender, message.content, 'self');

            // 4. 清空输入框
            messageInputEl.value = '';

            // 5. 【真实项目中】发送到后端接口（示例）
            // fetch('/api/chat/send', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify(message)
            // }).then(res => res.json())
            //   .then(data => {
            //       if (!data.success) {
            //           alert('消息发送失败：' + data.msg);
            //       }
            //   }).catch(err => {
            //       console.error('发送失败：', err);
            //       alert('网络异常，消息发送失败！');
            //   });

            // 模拟对方回复（仅演示用，真实项目需后端推送）
            setTimeout(() => {
                addMessageToChat('客服小C', `已收到你的消息：${messageContent}`, 'other');
            }, 800);
        }

        // ========== 辅助函数：添加消息到聊天窗口 ==========
        function addMessageToChat(sender, content, type) {
            // 创建消息项DOM
            const messageItem = document.createElement('div');
            messageItem.className = `message-item ${type}`;

            // 格式化内容（转义换行）
            const formattedContent = content.replace(/\n/g, '<br>');

            // 拼接HTML
            messageItem.innerHTML = `
                <div class="sender">${sender} · ${formatTime(new Date())}</div>
                <div class="content">${formattedContent}</div>
            `;

            // 添加到消息列表
            chatMessagesEl.appendChild(messageItem);

            // 自动滚动到底部
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // ========== 辅助函数：格式化时间 ==========
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>
