<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cait-Lab Á§æÂå∫ËÅäÂ§©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body { background-color: #f5f7fa; padding: 20px; }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-header {
            padding: 15px 20px;
            background: #0078d4;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            height: 500px;
            padding: 20px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .message-item {
            margin-bottom: 15px;
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }
        .message-item.self {
            margin-left: auto;
            align-items: flex-end;
        }
        .message-item.self .content {
            background: #0078d4;
            color: #fff;
            border-top-right-radius: 0;
        }
        .message-item.other {
            margin-right: auto;
            align-items: flex-start;
        }
        .message-item.other .content {
            background: #fff;
            color: #333;
            border: 1px solid #eee;
            border-top-left-radius: 0;
        }
        .message-item .sender {
            font-size: 12px;
            margin-bottom: 4px;
            padding: 0 8px;
        }
        .level-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        .admin-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        .super-admin-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        .message-item .time {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
        }
        .message-item .content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
            word-wrap: break-word;
        }
        .system-message {
            text-align: center;
            margin: 8px 0;
            font-size: 12px;
            color: #666;
            background: #f1f1f1;
            padding: 4px 12px;
            border-radius: 10px;
        }
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        #messageInput {
            flex: 1;
            resize: none;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            outline: none;
        }
        #sendMsgBtn {
            padding: 12px 25px;
            background: #0078d4;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #sendMsgBtn:disabled {
            background: #999;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <h3>Cait-Lab Á§æÂå∫ËÅäÂ§©</h3>
        <div class="user-info">
            ÂΩìÂâçÁôªÂΩïÔºö<span id="loginNickname"></span>
            <span id="loginLevel" class="level-badge"></span>
            <span id="loginAdminBadge"></span>
        </div>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="loading">Âä†ËΩΩ‰∏≠...</div>
    </div>
    <div class="chat-input-area">
        <div class="input-wrapper">
            <textarea id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ... /Help Êü•ÁúãÊåá‰ª§"></textarea>
            <button id="sendMsgBtn">ÂèëÈÄÅ</button>
        </div>
    </div>
</div>

<script>
// ========== ÈÖçÁΩÆÔºà‰Ω†ÁöÑ‰ø°ÊÅØ‰∏çÂä®Ôºâ ==========
const SUPER_ADMIN = "Pu_cait";
const SYSTEM = "SYSTEM";
const DEFAULT_MSG = `${SYSTEM}|${Date.now()}:Ê¨¢ËøéÊù•Âà∞ Cait-Lab Á§æÂå∫ËÅäÂ§©ÔºÅ`;

const TOKEN_A = "ghp_";
const TOKEN_B = "sp39r4hPD5KJDtPLUJyV9jIW5wcwcc0HVRF7";
const GITHUB_TOKEN = TOKEN_A + TOKEN_B;
const GIST_ID = "46a3964342f2b5338bd95b12e3911fba";

// ========== ÂÖ®Â±ÄÂèòÈáè ==========
let currentUser = { username: "guest", nickname: "Ê∏∏ÂÆ¢", level: "1", isAdmin: false };
let isMuted = false;
const cache = { chat: [], admin: [], muted: [] };

const $ = (id) => document.getElementById(id);
const loginNick = $("loginNickname");
const loginLevel = $("loginLevel");
const loginBadge = $("loginAdminBadge");
const msgInput = $("messageInput");
const sendBtn = $("sendMsgBtn");
const msgBox = $("chatMessages");

// ========== ËØªÂèñÊú¨Âú∞ÁôªÂΩï ==========
function loadUser() {
    try {
        let u = localStorage.getItem("caitlab_currentUser");
        if (u) currentUser = JSON.parse(u);
        else {
            msgBox.innerHTML = `<div class="system-message">ËØ∑ÂÖàÁôªÂΩï</div>`;
            msgInput.disabled = true;
            sendBtn.disabled = true;
        }
    } catch (e) {}
}

// ========== ÊúÄÁ®≥ Gist ËØªÂÜô ==========
async function getFile(file) {
    let res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    let data = await res.json();
    return data.files[file]?.content || "";
}

async function putFile(file, content) {
    let res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
        method: "PATCH",
        headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ files: { [file]: { content } } })
    });
    return res.ok;
}

// ========== ËÅäÂ§©ËÆ∞ÂΩï ==========
async function loadChat(force = false) {
    if (cache.chat.length && !force) return;
    let txt = await getFile("chat_content.md") || DEFAULT_MSG;
    cache.chat = txt.split("\n").filter(Boolean);
    render();
}

async function sendChat(text) {
    let old = await getFile("chat_content.md") || DEFAULT_MSG;
    let line = `${currentUser.username}|${Date.now()}:${text}`;
    let ok = await putFile("chat_content.md", old + "\n" + line);
    if (ok) {
        cache.chat = [];
        await loadChat(true);
    } else {
        sysMsg("‚ùå ÂèëÈÄÅÂ§±Ë¥•");
    }
}

// ========== Ê∏≤Êüì ==========
function sysMsg(text) {
    msgBox.innerHTML += `<div class="system-message">${text}</div>`;
    msgBox.scrollTop = msgBox.scrollHeight;
}

function render() {
    msgBox.innerHTML = "";
    cache.chat.forEach(line => {
        let i = line.indexOf("|"), j = line.indexOf(":", i);
        if (i == -1 || j == -1) return;
        let user = line.slice(0, i).trim();
        let time = line.slice(i+1, j).trim();
        let cont = line.slice(j+1).trim();
        
        let self = user == currentUser.username;
        let isSA = user == SUPER_ADMIN;
        let isAdmin = cache.admin.includes(user) && !isSA;
        
        msgBox.innerHTML += `
        <div class="message-item ${self ? 'self' : 'other'}">
            <div class="sender">
                ${user}
                <span class="level-badge">Lv.${isSA ? '999+' : '1'}</span>
                ${isSA ? '<span class="super-admin-badge">Ë∂ÖÁÆ°</span>' : ''}
                ${isAdmin ? '<span class="admin-badge">ÁÆ°ÁêÜÂëò</span>' : ''}
            </div>
            <div class="content">${cont}</div>
            <div class="time">${new Date(+time).toLocaleString()}</div>
        </div>`;
    });
    msgBox.scrollTop = msgBox.scrollHeight;
}

// ========== Êåá‰ª§ ==========
async function cmd(cmd) {
    cmd = cmd.trim().toLowerCase();
    if (cmd == "/help") sysMsg("üìã /Rfr Âà∑Êñ∞ | /cls Ê∏ÖÁ©∫ÔºàÁÆ°ÁêÜÂëòÔºâ");
    if (cmd == "/rfr" || cmd == "/refresh") { cache.chat = []; await loadChat(true); sysMsg("‚úÖ Â∑≤Âà∑Êñ∞"); }
    if (cmd == "/cls" || cmd == "/clean") {
        if (currentUser.username != SUPER_ADMIN) return sysMsg("‚ùå Êó†ÊùÉÈôê");
        await putFile("chat_content.md", DEFAULT_MSG);
        cache.chat = [];
        await loadChat(true);
        sysMsg("‚úÖ Â∑≤Ê∏ÖÁ©∫");
    }
}

// ========== ÂèëÈÄÅÊåâÈíÆ ==========
async function send() {
    let t = msgInput.value.trim();
    if (!t) return;
    sendBtn.disabled = true;
    
    if (t.startsWith("/")) await cmd(t);
    else await sendChat(t);
    
    msgInput.value = "";
    sendBtn.disabled = false;
}

// ========== ÂàùÂßãÂåñ ==========
async function init() {
    loadUser();
    loginNick.textContent = currentUser.nickname;
    loginLevel.textContent = `Lv.${currentUser.level}`;
    
    if (currentUser.username == SUPER_ADMIN) {
        loginBadge.className = "super-admin-badge";
        loginBadge.textContent = "Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò";
    }

    await loadChat(true);
    
    sendBtn.onclick = send;
    msgInput.addEventListener("keydown", e => {
        if (e.key == "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
    });
}

window.onload = init;
</script>
</body>
</html>