<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cait-Lab ç¤¾åŒºèŠå¤©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body { background-color: #f5f7fa; padding: 20px; }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-header {
            padding: 15px 20px;
            background: #0078d4;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            height: 500px;
            padding: 20px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .message-item {
            margin-bottom: 15px;
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }
        .message-item.self {
            margin-left: auto;
            align-items: flex-end;
        }
        .message-item.self .content {
            background: #0078d4;
            color: #fff;
            border-top-right-radius: 0;
        }
        .message-item.other {
            margin-right: auto;
            align-items: flex-start;
        }
        .message-item.other .content {
            background: #fff;
            color: #333;
            border: 1px solid #eee;
            border-top-left-radius: 0;
        }
        .message-item .sender {
            font-size: 12px;
            margin-bottom: 4px;
            padding: 0 8px;
        }
        .level-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        .admin-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        .super-admin-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        .muted-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        .message-item .time {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
        }
        .message-item .content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
            word-wrap: break-word;
        }
        .system-message {
            text-align: center;
            margin: 8px 0;
            font-size: 12px;
            color: #666;
            background: #f1f1f1;
            padding: 4px 12px;
            border-radius: 10px;
        }
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        #messageInput {
            flex: 1;
            resize: none;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            outline: none;
        }
        #messageInput:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        #sendMsgBtn {
            padding: 12px 25px;
            background: #0078d4;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #sendMsgBtn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .muted-tip {
            color: #dc3545;
            font-size: 12px;
            margin-top: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <h3>Cait-Lab ç¤¾åŒºèŠå¤©</h3>
        <div class="user-info">
            å½“å‰ç™»å½•ï¼š<span id="loginNickname"></span>
            <span id="loginLevel" class="level-badge"></span>
            <span id="loginAdminBadge"></span>
        </div>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
    <div class="chat-input-area">
        <div class="input-wrapper">
            <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯... /Help æŸ¥çœ‹æŒ‡ä»¤"></textarea>
            <button id="sendMsgBtn">å‘é€</button>
        </div>
        <div id="mutedTip" class="muted-tip" style="display: none;">âš ï¸ ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯</div>
    </div>
</div>

<script>
// ========== é…ç½®ï¼ˆä½ çš„ä¿¡æ¯ä¸åŠ¨ï¼‰ ==========
const SUPER_ADMIN = "Pu_cait";
const SYSTEM = "SYSTEM";
const DEFAULT_MSG = `${SYSTEM}|${Date.now()}:æ¬¢è¿æ¥åˆ° Cait-Lab ç¤¾åŒºèŠå¤©ï¼`;

const TOKEN_A = "ghp_";
const TOKEN_B = "sp39r4hPD5KJDtPLUJyV9jIW5wcwcc0HVRF7";
const GITHUB_TOKEN = TOKEN_A + TOKEN_B;
const GIST_ID = "46a3964342f2b5338bd95b12e3911fba";

// ========== å…¨å±€å˜é‡ ==========
let currentUser = { username: "guest", nickname: "æ¸¸å®¢", level: "1", isAdmin: false };
let isMuted = false; // æ ‡è®°å½“å‰ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
const cache = { chat: [], admin: [], muted: [] };

const $ = (id) => document.getElementById(id);
const loginNick = $("loginNickname");
const loginLevel = $("loginLevel");
const loginBadge = $("loginAdminBadge");
const msgInput = $("messageInput");
const sendBtn = $("sendMsgBtn");
const msgBox = $("chatMessages");
const mutedTip = $("mutedTip");

// ========== è¯»å–æœ¬åœ°ç™»å½• ==========
function loadUser() {
    try {
        let u = localStorage.getItem("caitlab_currentUser");
        if (u) currentUser = JSON.parse(u);
        else {
            msgBox.innerHTML = `<div class="system-message">è¯·å…ˆç™»å½•</div>`;
            msgInput.disabled = true;
            sendBtn.disabled = true;
        }
    } catch (e) {}
}

// ========== æœ€ç¨³ Gist è¯»å†™ ==========
async function getFile(file) {
    let res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    let data = await res.json();
    return data.files[file]?.content || "";
}

async function putFile(file, content) {
    let res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
        method: "PATCH",
        headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ files: { [file]: { content } } })
    });
    return res.ok;
}

// ========== ç¦è¨€åˆ—è¡¨å¤„ç†ï¼ˆæ ¸å¿ƒæ–°å¢ï¼‰ ==========
async function loadMutedList() {
    // è¯»å–ç¦è¨€åˆ—è¡¨
    let txt = await getFile("muted_users.md") || "";
    cache.muted = txt.split("\n").map(u => u.trim()).filter(u => u && u !== SYSTEM);
    // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
    isMuted = cache.muted.includes(currentUser.username);
    // ç«‹åˆ»é”æ­»è¾“å…¥æ¡†
    if (isMuted) {
        msgInput.disabled = true;
        sendBtn.disabled = true;
        msgInput.placeholder = "ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•è¾“å…¥æ¶ˆæ¯";
        mutedTip.style.display = "block"; // æ˜¾ç¤ºç¦è¨€æç¤º
    }
}

// ========== ç®¡ç†å‘˜åˆ—è¡¨å¤„ç† ==========
async function loadAdminList() {
    let txt = await getFile("admin_list.md") || SUPER_ADMIN;
    cache.admin = txt.split("\n").map(u => u.trim()).filter(u => u);
    currentUser.isAdmin = cache.admin.includes(currentUser.username);
    
    // æ¸²æŸ“ç®¡ç†å‘˜å¾½ç« 
    if (currentUser.username === SUPER_ADMIN) {
        loginBadge.className = "super-admin-badge";
        loginBadge.textContent = "è¶…çº§ç®¡ç†å‘˜";
    } else if (currentUser.isAdmin) {
        loginBadge.className = "admin-badge";
        loginBadge.textContent = "ç®¡ç†å‘˜";
    }
}

// ========== èŠå¤©è®°å½• ==========
async function loadChat(force = false) {
    if (cache.chat.length && !force) return;
    let txt = await getFile("chat_content.md") || DEFAULT_MSG;
    cache.chat = txt.split("\n").filter(Boolean);
    render();
}

async function sendChat(text) {
    // åŒé‡æ ¡éªŒï¼šç¦è¨€ç”¨æˆ·ç›´æ¥æ‹¦æˆªï¼Œä¸è®©å‘é€
    if (isMuted) {
        sysMsg("âŒ ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
        return;
    }
    
    let old = await getFile("chat_content.md") || DEFAULT_MSG;
    let line = `${currentUser.username}|${Date.now()}:${text}`;
    let ok = await putFile("chat_content.md", old + "\n" + line);
    if (ok) {
        cache.chat = [];
        await loadChat(true);
    } else {
        sysMsg("âŒ å‘é€å¤±è´¥");
    }
}

// ========== æ¸²æŸ“ ==========
function sysMsg(text) {
    msgBox.innerHTML += `<div class="system-message">${text}</div>`;
    msgBox.scrollTop = msgBox.scrollHeight;
}

function render() {
    msgBox.innerHTML = "";
    cache.chat.forEach(line => {
        let i = line.indexOf("|"), j = line.indexOf(":", i);
        if (i == -1 || j == -1) return;
        let user = line.slice(0, i).trim();
        let time = line.slice(i+1, j).trim();
        let cont = line.slice(j+1).trim();
        
        let self = user == currentUser.username;
        let isSA = user == SUPER_ADMIN;
        let isAdmin = cache.admin.includes(user) && !isSA;
        let isUserMuted = cache.muted.includes(user); // æ£€æŸ¥æ¶ˆæ¯å‘é€è€…æ˜¯å¦è¢«ç¦è¨€
        
        msgBox.innerHTML += `
        <div class="message-item ${self ? 'self' : 'other'}">
            <div class="sender">
                ${user}
                <span class="level-badge">Lv.${isSA ? '999+' : '1'}</span>
                ${isSA ? '<span class="super-admin-badge">è¶…ç®¡</span>' : ''}
                ${isAdmin ? '<span class="admin-badge">ç®¡ç†å‘˜</span>' : ''}
                ${isUserMuted ? '<span class="muted-badge">å·²ç¦è¨€</span>' : ''}
            </div>
            <div class="content">${cont}</div>
            <div class="time">${new Date(+time).toLocaleString()}</div>
        </div>`;
    });
    msgBox.scrollTop = msgBox.scrollHeight;
}

// ========== æŒ‡ä»¤ ==========
async function cmd(cmd) {
    cmd = cmd.trim().toLowerCase();
    if (cmd == "/help") sysMsg("ğŸ“‹ /Rfr åˆ·æ–° | /cls æ¸…ç©ºï¼ˆç®¡ç†å‘˜ï¼‰ | /M_u <ç”¨æˆ·å> ç¦è¨€ï¼ˆç®¡ç†å‘˜ï¼‰ | /UM_u <ç”¨æˆ·å> è§£é™¤ç¦è¨€ï¼ˆç®¡ç†å‘˜ï¼‰");
    if (cmd == "/rfr" || cmd == "/refresh") { 
        cache.chat = []; 
        await loadChat(true); 
        sysMsg("âœ… å·²åˆ·æ–°æœ€æ–°èŠå¤©è®°å½•"); 
    }
    if (cmd == "/cls" || cmd == "/clean") {
        if (!currentUser.isAdmin) return sysMsg("âŒ ä»…ç®¡ç†å‘˜å¯æ¸…ç©ºèŠå¤©è®°å½•");
        await putFile("chat_content.md", DEFAULT_MSG);
        cache.chat = [];
        await loadChat(true);
        sysMsg("âœ… èŠå¤©è®°å½•å·²æ¸…ç©º");
    }
    // ç¦è¨€æŒ‡ä»¤ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
    if (cmd.startsWith("/m_u") || cmd.startsWith("/m_usr")) {
        if (!currentUser.isAdmin) return sysMsg("âŒ ä»…ç®¡ç†å‘˜å¯ç¦è¨€ç”¨æˆ·");
        let target = cmd.split(" ")[1];
        if (!target) return sysMsg("âŒ æ ¼å¼é”™è¯¯ï¼š/M_u <ç”¨æˆ·å>");
        if (target === SUPER_ADMIN) return sysMsg("âŒ ä¸èƒ½ç¦è¨€è¶…çº§ç®¡ç†å‘˜");
        if (cache.admin.includes(target)) return sysMsg("âŒ ä¸èƒ½ç¦è¨€ç®¡ç†å‘˜");
        
        let mutedList = [...cache.muted];
        if (mutedList.includes(target)) return sysMsg("âŒ è¯¥ç”¨æˆ·å·²è¢«ç¦è¨€");
        mutedList.push(target);
        await putFile("muted_users.md", mutedList.join("\n"));
        cache.muted = mutedList;
        // å¦‚æœç¦è¨€çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œç«‹åˆ»é”æ­»è¾“å…¥æ¡†
        if (target === currentUser.username) {
            isMuted = true;
            msgInput.disabled = true;
            sendBtn.disabled = true;
            msgInput.placeholder = "ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•è¾“å…¥æ¶ˆæ¯";
            mutedTip.style.display = "block";
        }
        sysMsg(`âœ… å·²ç¦è¨€ ${target}`);
        await loadChat(true);
    }
    // è§£é™¤ç¦è¨€æŒ‡ä»¤ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
    if (cmd.startsWith("/um_u") || cmd.startsWith("/um_usr")) {
        if (!currentUser.isAdmin) return sysMsg("âŒ ä»…ç®¡ç†å‘˜å¯è§£é™¤ç¦è¨€");
        let target = cmd.split(" ")[1];
        if (!target) return sysMsg("âŒ æ ¼å¼é”™è¯¯ï¼š/UM_u <ç”¨æˆ·å>");
        
        let mutedList = cache.muted.filter(u => u !== target);
        await putFile("muted_users.md", mutedList.join("\n") || SYSTEM);
        cache.muted = mutedList;
        // å¦‚æœè§£é™¤çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œç«‹åˆ»è§£é”è¾“å…¥æ¡†
        if (target === currentUser.username) {
            isMuted = false;
            msgInput.disabled = false;
            sendBtn.disabled = false;
            msgInput.placeholder = "è¾“å…¥æ¶ˆæ¯... /Help æŸ¥çœ‹æŒ‡ä»¤";
            mutedTip.style.display = "none";
        }
        sysMsg(`âœ… å·²è§£é™¤ ${target} çš„ç¦è¨€`);
        await loadChat(true);
    }
}

// ========== å‘é€æŒ‰é’® ==========
async function send() {
    // ç¦è¨€ç”¨æˆ·ç›´æ¥æ‹¦æˆª
    if (isMuted) {
        sysMsg("âš ï¸ ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
        return;
    }
    
    let t = msgInput.value.trim();
    if (!t) return;
    sendBtn.disabled = true;
    
    if (t.startsWith("/")) await cmd(t);
    else await sendChat(t);
    
    msgInput.value = "";
    sendBtn.disabled = false;
}

// ========== åˆå§‹åŒ– ==========
async function init() {
    loadUser();
    loginNick.textContent = currentUser.nickname;
    loginLevel.textContent = `Lv.${currentUser.level}`;

    // å…ˆåŠ è½½ç¦è¨€åˆ—è¡¨ï¼Œç«‹åˆ»é”æ­»ç¦è¨€ç”¨æˆ·
    await loadMutedList();
    // åŠ è½½ç®¡ç†å‘˜åˆ—è¡¨
    await loadAdminList();
    // åŠ è½½èŠå¤©è®°å½•
    await loadChat(true);
    
    // ç»‘å®šäº‹ä»¶
    sendBtn.onclick = send;
    msgInput.addEventListener("keydown", e => {
        if (e.key == "Enter" && !e.shiftKey) { 
            e.preventDefault(); 
            send(); 
        }
    });
    
    // åˆ·æ–°é¡µé¢ä¹Ÿä¿æŒç¦è¨€çŠ¶æ€
    window.addEventListener("load", () => {
        if (isMuted) {
            msgInput.disabled = true;
            sendBtn.disabled = true;
            mutedTip.style.display = "block";
        }
    });
}

window.onload = init;
</script>
</body>
</html>