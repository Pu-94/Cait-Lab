<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cait-Lab ç¤¾åŒºèŠå¤©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body { background-color: #f5f7fa; padding: 20px; }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-header {
            padding: 15px 20px;
            background: #0078d4;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            height: 500px;
            padding: 20px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .message-item {
            margin-bottom: 15px;
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }
        .message-item.self {
            margin-left: auto;
            align-items: flex-end;
        }
        .message-item.self .content {
            background: #0078d4;
            color: #fff;
            border-top-right-radius: 0;
        }
        .message-item.other {
            margin-right: auto;
            align-items: flex-start;
        }
        .message-item.other .content {
            background: #fff;
            color: #333;
            border: 1px solid #eee;
            border-top-left-radius: 0;
        }
        .message-item .sender {
            font-size: 12px;
            margin-bottom: 4px;
            padding: 0 8px;
        }
        .level-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        .admin-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        .super-admin-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        .message-item .time {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
        }
        .message-item .content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
            word-wrap: break-word;
        }
        .system-message {
            text-align: center;
            margin: 8px 0;
            font-size: 12px;
            color: #666;
            background: #f1f1f1;
            padding: 4px 12px;
            border-radius: 10px;
        }
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        #messageInput {
            flex: 1;
            resize: none;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            outline: none;
        }
        #sendMsgBtn {
            padding: 12px 25px;
            background: #0078d4;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #sendMsgBtn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        #messageInput:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            color: #999;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .muted-tip {
            text-align: center;
            color: #dc3545;
            font-size: 12px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <h3>Cait-Lab ç¤¾åŒºèŠå¤©</h3>
        <div class="user-info">
            å½“å‰ç™»å½•ï¼š<span id="loginNickname"></span>
            <span id="loginLevel" class="level-badge"></span>
            <span id="loginAdminBadge"></span>
        </div>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
    <div class="chat-input-area">
        <div class="input-wrapper">
            <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯... /Help æŸ¥çœ‹æŒ‡ä»¤"></textarea>
            <button id="sendMsgBtn">å‘é€</button>
        </div>
        <div id="mutedTip" class="muted-tip" style="display: none;">ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ï¼</div>
    </div>
</div>

<script>
// ========== é…ç½® ==========
const SUPER_ADMIN = "Pu_cait";
const SYSTEM = "SYSTEM";
const DEFAULT_MSG = `${SYSTEM}|${Date.now()}:æ¬¢è¿æ¥åˆ° Cait-Lab ç¤¾åŒºèŠå¤©ï¼`;

const TOKEN_A = "ghp_";
const TOKEN_B = "sp39r4hPD5KJDtPLUJyV9jIW5wcwcc0HVRF7";
const GITHUB_TOKEN = TOKEN_A + TOKEN_B;
const GIST_ID = "46a3964342f2b5338bd95b12e3911fba";
const GIST_URL = `https://gist.github.com/Pu-94/${GIST_ID}`;
// è·¨åŸŸä»£ç†ï¼ˆè§£å†³å‰ç«¯è®¿é—®Gistç½‘é¡µçš„è·¨åŸŸé—®é¢˜ï¼Œä»…ç”¨äºæµ‹è¯•ï¼‰
const CORS_PROXY = "https://corsproxy.io/?";

// ========== å…¨å±€å˜é‡ ==========
let currentUser = { username: "guest", nickname: "æ¸¸å®¢", level: "1", isAdmin: false, isMuted: false };
let isMuted = false;
const cache = { chat: [], admin: [], muted: [] };

const $ = (id) => document.getElementById(id);
const loginNick = $("loginNickname");
const loginLevel = $("loginLevel");
const loginBadge = $("loginAdminBadge");
const msgInput = $("messageInput");
const sendBtn = $("sendMsgBtn");
const msgBox = $("chatMessages");
const mutedTip = $("mutedTip");

// ========== è¯»å–æœ¬åœ°ç™»å½• ==========
function loadUser() {
    try {
        let u = localStorage.getItem("caitlab_currentUser");
        if (u) {
            currentUser = JSON.parse(u);
            isMuted = currentUser.isMuted || false;
        } else {
            msgBox.innerHTML = `<div class="system-message">è¯·å…ˆç™»å½•</div>`;
            msgInput.disabled = true;
            sendBtn.disabled = true;
        }
    } catch (e) {}
}

// ========== æ ¸å¿ƒä¿®æ”¹ï¼šä»Gistç½‘é¡µè¯»å–æ–‡ä»¶å†…å®¹ ==========
async function getFileFromWebpage(filename) {
    try {
        // ä½¿ç”¨è·¨åŸŸä»£ç†è®¿é—®Gistç½‘é¡µï¼ˆè§£å†³CORSé™åˆ¶ï¼‰
        const response = await fetch(`${CORS_PROXY}${encodeURIComponent(GIST_URL)}`);
        if (!response.ok) throw new Error("è®¿é—®Gistç½‘é¡µå¤±è´¥");
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        
        // æŸ¥æ‰¾å¯¹åº”æ–‡ä»¶çš„å†…å®¹åŒºåŸŸï¼ˆGistç½‘é¡µçš„DOMç»“æ„ï¼‰
        const fileElements = doc.querySelectorAll(".file-box");
        let fileContent = "";
        
        for (const fileEl of fileElements) {
            // è·å–æ–‡ä»¶å
            const fileTitle = fileEl.querySelector(".file-title a")?.textContent?.trim();
            if (fileTitle === filename) {
                // æå–æ–‡ä»¶å†…å®¹ï¼ˆGistä¸­ä»£ç è¡Œçš„é€‰æ‹©å™¨ï¼‰
                const codeLines = fileEl.querySelectorAll(".blob-code");
                const contentLines = [];
                codeLines.forEach(line => {
                    contentLines.push(line.textContent?.trim() || "");
                });
                fileContent = contentLines.join("\n");
                break;
            }
        }
        
        return fileContent || "";
    } catch (error) {
        console.error("è¯»å–Gistç½‘é¡µå¤±è´¥ï¼š", error);
        // è¯»å–å¤±è´¥æ—¶è¿”å›é»˜è®¤å€¼
        if (filename === "chat_content.md") return DEFAULT_MSG;
        return "";
    }
}

// æ›¿æ¢åŸæ¥çš„getFileå‡½æ•°
async function getFile(file) {
    return await getFileFromWebpage(file);
}

// ========== ä¿ç•™åŸæœ‰APIå†™å…¥é€»è¾‘ ==========
async function putFile(file, content) {
    let res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
        method: "PATCH",
        headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ files: { [file]: { content } } })
    });
    return res.ok;
}

// ========== èŠå¤©è®°å½•å¤„ç† ==========
async function loadChat(force = false) {
    if (cache.chat.length && !force) return;
    
    // åŠ è½½èŠå¤©è®°å½•
    let txt = await getFile("chat_content.md") || DEFAULT_MSG;
    cache.chat = txt.split("\n").filter(Boolean);
    
    // åŠ è½½ç®¡ç†å‘˜åˆ—è¡¨
    let adminTxt = await getFile("admin_list.md") || "";
    cache.admin = adminTxt.split("\n").filter(Boolean);
    
    // åŠ è½½ç¦è¨€ç”¨æˆ·åˆ—è¡¨
    let mutedTxt = await getFile("muted_users.md") || "";
    cache.muted = mutedTxt.split("\n").filter(Boolean);
    // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
    isMuted = cache.muted.includes(currentUser.username);
    
    render();
}

async function sendChat(text) {
    let old = await getFile("chat_content.md") || DEFAULT_MSG;
    let line = `${currentUser.username}|${Date.now()}:${text}`;
    let ok = await putFile("chat_content.md", old + "\n" + line);
    if (ok) {
        cache.chat = [];
        await loadChat(true);
    } else {
        sysMsg("âŒ å‘é€å¤±è´¥");
    }
}

// ========== æ¸²æŸ“ä¸æç¤º ==========
function sysMsg(text) {
    msgBox.innerHTML += `<div class="system-message">${text}</div>`;
    msgBox.scrollTop = msgBox.scrollHeight;
}

function render() {
    msgBox.innerHTML = "";
    cache.chat.forEach(line => {
        let i = line.indexOf("|"), j = line.indexOf(":", i);
        if (i == -1 || j == -1) return;
        let user = line.slice(0, i).trim();
        let time = line.slice(i+1, j).trim();
        let cont = line.slice(j+1).trim();
        
        let self = user == currentUser.username;
        let isSA = user == SUPER_ADMIN;
        let isAdmin = cache.admin.includes(user) && !isSA;
        
        msgBox.innerHTML += `
        <div class="message-item ${self ? 'self' : 'other'}">
            <div class="sender">
                ${user}
                <span class="level-badge">Lv.${isSA ? '999+' : '1'}</span>
                ${isSA ? '<span class="super-admin-badge">è¶…ç®¡</span>' : ''}
                ${isAdmin ? '<span class="admin-badge">ç®¡ç†å‘˜</span>' : ''}
            </div>
            <div class="content">${cont}</div>
            <div class="time">${new Date(+time).toLocaleString()}</div>
        </div>`;
    });
    msgBox.scrollTop = msgBox.scrollHeight;
}

// ========== æŒ‡ä»¤å¤„ç† ==========
async function cmd(cmd) {
    cmd = cmd.trim().toLowerCase();
    if (cmd == "/help") sysMsg("ğŸ“‹ /Rfr åˆ·æ–° | /cls æ¸…ç©ºï¼ˆç®¡ç†å‘˜ï¼‰");
    if (cmd == "/rfr" || cmd == "/refresh") { 
        cache.chat = []; 
        await loadChat(true); 
        sysMsg("âœ… å·²åˆ·æ–°"); 
    }
    if (cmd == "/cls" || cmd == "/clean") {
        if (currentUser.username != SUPER_ADMIN) return sysMsg("âŒ æ— æƒé™");
        await putFile("chat_content.md", DEFAULT_MSG);
        cache.chat = [];
        await loadChat(true);
        sysMsg("âœ… å·²æ¸…ç©º");
    }
}

// ========== å‘é€é€»è¾‘ ==========
async function send() {
    if (isMuted) {
        sysMsg("âŒ ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ï¼");
        return;
    }
    
    let t = msgInput.value.trim();
    if (!t) return;
    sendBtn.disabled = true;
    
    if (t.startsWith("/")) await cmd(t);
    else await sendChat(t);
    
    msgInput.value = "";
    sendBtn.disabled = false;
}

// ========== ç¦è¨€çŠ¶æ€å¤„ç† ==========
function handleMutedState() {
    if (isMuted) {
        msgInput.disabled = true;
        sendBtn.disabled = true;
        msgInput.placeholder = "ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯...";
        mutedTip.style.display = "block";
    } else {
        if (currentUser.username !== "guest") {
            msgInput.disabled = false;
            sendBtn.disabled = false;
            msgInput.placeholder = "è¾“å…¥æ¶ˆæ¯... /Help æŸ¥çœ‹æŒ‡ä»¤";
        }
        mutedTip.style.display = "none";
    }
}

// ========== åˆå§‹åŒ– ==========
async function init() {
    loadUser();
    loginNick.textContent = currentUser.nickname;
    loginLevel.textContent = `Lv.${currentUser.level}`;
    
    if (currentUser.username == SUPER_ADMIN) {
        loginBadge.className = "super-admin-badge";
        loginBadge.textContent = "è¶…çº§ç®¡ç†å‘˜";
    }

    await loadChat(true);
    handleMutedState();
    
    sendBtn.onclick = send;
    msgInput.addEventListener("keydown", e => {
        if (e.key == "Enter" && !e.shiftKey) { 
            e.preventDefault(); 
            send(); 
        }
    });
}

window.onload = init;
</script>
</body>
</html>