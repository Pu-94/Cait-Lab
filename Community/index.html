<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cait-Lab ç¤¾åŒºèŠå¤©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        body {
            background-color: #f5f7fa;
            padding: 20px;
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-header {
            padding: 15px 20px;
            background-color: #0078d4;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 18px;
            font-weight: 500;
        }

        .user-info {
            font-size: 14px;
        }

        .user-info span {
            font-weight: bold;
        }

        .chat-messages {
            height: 500px;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        .message-item {
            margin-bottom: 15px;
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }

        .message-item.self {
            margin-left: auto;
            align-items: flex-end;
        }

        .message-item.self .content {
            background-color: #0078d4;
            color: #fff;
            border-top-right-radius: 0;
        }

        .message-item.other {
            margin-right: auto;
            align-items: flex-start;
        }

        .message-item.other .content {
            background-color: #fff;
            color: #333;
            border: 1px solid #eee;
            border-top-left-radius: 0;
        }

        .message-item .sender {
            font-size: 12px;
            margin-bottom: 4px;
            padding: 0 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message-item.self .sender {
            color: #0078d4;
            text-align: right;
            justify-content: flex-end;
        }

        .message-item.other .sender {
            color: #666;
            text-align: left;
        }

        .level-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .admin-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 4px;
        }

        .message-item .time {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
            padding: 0 8px;
        }

        .message-item.self .time {
            text-align: right;
        }

        .message-item.other .time {
            text-align: left;
        }

        .message-item .content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
            word-wrap: break-word;
        }

        .system-message {
            text-align: center;
            margin: 8px 0;
            font-size: 12px;
            color: #666;
            background: #f1f1f1;
            padding: 4px 12px;
            border-radius: 10px;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .command-list {
            text-align: left;
            font-size: 12px;
            line-height: 1.6;
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            resize: none;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            outline: none;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            border-color: #0078d4;
        }

        #sendMsgBtn {
            padding: 12px 25px;
            background-color: #0078d4;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        #sendMsgBtn:hover {
            background-color: #005a9e;
        }

        #sendMsgBtn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h3>Cait-Lab ç¤¾åŒºèŠå¤©</h3>
            <div class="user-info">
                å½“å‰ç™»å½•ï¼š<span id="loginNickname">åŠ è½½ä¸­...</span>
                <span id="loginLevel" class="level-badge" style="margin-left: 5px; font-size: 10px;"></span>
                <span id="loginAdminBadge" class="admin-badge" style="display: none;">ç®¡ç†å‘˜</span>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="loading">æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...</div>
        </div>
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    placeholder="è¯·è¾“å…¥èŠå¤©å†…å®¹"
                    spellcheck="false"
                ></textarea>
                <button id="sendMsgBtn">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        // ========== é…ç½®é¡¹ ==========
        const a_token = 'ghp_';
        const b_token = 'sp39r4hPD5KJDtPLUJyV9jIW5wcwcc0HVRF7';
        const GITHUB_TOKEN = a_token + b_token;
        const OWNER = 'pu-94';
        const REPO = 'Cait-Lab';
        const BASE_URL = 'https://api.github.com';
        const CHAT_CONTENT_PATH = 'Community/Content.txt';
        const ADMIN_FILE_PATH = 'Community/Admin.txt';
        const SUPER_ADMIN_USERNAME = 'Pu_cait';
        const DEBUG = true;
        const SYNC_INTERVAL = 10000; // è‡ªåŠ¨åŒæ­¥é—´éš”(ms)

        // ========== å…¨å±€ç¼“å­˜ - æ ¸å¿ƒä¼˜åŒ– ==========
        const cache = {
            userInfo: {},        // {username: {nickname, level, isAdmin}}
            adminList: [],       // ç®¡ç†å‘˜ç”¨æˆ·ååˆ—è¡¨
            chatHistory: [],     // èŠå¤©è®°å½•æ•°ç»„
            chatSha: null,       // èŠå¤©æ–‡ä»¶shaå€¼(nullè¡¨ç¤ºæ–‡ä»¶ä¸å­˜åœ¨)
            chatFileExists: false// èŠå¤©æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        };

        // ========== é¡µé¢å…ƒç´  ==========
        const loginNicknameEl = document.getElementById('loginNickname');
        const loginLevelEl = document.getElementById('loginLevel');
        const loginAdminBadgeEl = document.getElementById('loginAdminBadge');
        const messageInputEl = document.getElementById('messageInput');
        const sendMsgBtnEl = document.getElementById('sendMsgBtn');
        const chatMessagesEl = document.getElementById('chatMessages');

        // ========== å…¨å±€å˜é‡ ==========
        let currentUser = null;
        let loginUsername = '';
        let loginNickname = '';
        let loginLevel = '';
        let isAdmin = false;
        let syncTimer = null; // è‡ªåŠ¨åŒæ­¥å®šæ—¶å™¨

        // ========== å·¥å…·å‡½æ•° ==========
        function logDebug(message, data = null) {
            if (DEBUG) console.log(`[DEBUG] ${message}`, data || '');
        }

        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(timestamp) {
            const date = new Date(Number(timestamp));
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,0)}-${date.getDate().toString().padStart(2,0)} ${date.getHours().toString().padStart(2,0)}:${date.getMinutes().toString().padStart(2,0)}:${date.getSeconds().toString().padStart(2,0)}`;
        }

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶è·å–æœ€æ–°sha
        async function checkFileStatus(path) {
            try {
                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    headers: { 
                        'Authorization': `token ${GITHUB_TOKEN}`, 
                        'Accept': 'application/vnd.github.v3+json',
                        'Cache-Control': 'max-age=10, s-maxage=10'
                    }
                });
                if (response.status === 200) {
                    const data = await response.json();
                    return { exists: true, sha: data.sha };
                }
                return { exists: false, sha: null };
            } catch (error) {
                logDebug(`æ£€æŸ¥æ–‡ä»¶çŠ¶æ€å¤±è´¥: ${error.message}`);
                return { exists: false, sha: null };
            }
        }

        // è¯»å–æ–‡ä»¶å†…å®¹
        async function readFile(path) {
            try {
                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    headers: { 
                        'Authorization': `token ${GITHUB_TOKEN}`, 
                        'Accept': 'application/vnd.github.v3+json',
                        'Cache-Control': 'max-age=10, s-maxage=10'
                    }
                });
                if (response.status !== 200) return { content: '', sha: null };
                const data = await response.json();
                return { 
                    content: atob(data.content.replace(/\n/g, '')), 
                    sha: data.sha 
                };
            } catch (error) {
                logDebug(`è¯»å–æ–‡ä»¶å¤±è´¥: ${error.message}`);
                return { content: '', sha: null };
            }
        }

        // å†™å…¥æ–‡ä»¶ - è‡ªåŠ¨å¤„ç†åˆ›å»º/æ›´æ–°(è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦ä¼ sha)
        async function writeFile(path, content, commitMessage) {
            try {
                // å…ˆæ£€æŸ¥æ–‡ä»¶çŠ¶æ€ï¼Œç¡®å®šæ˜¯åˆ›å»ºè¿˜æ˜¯æ›´æ–°
                const fileStatus = await checkFileStatus(path);
                const requestBody = { 
                    message: commitMessage, 
                    content: btoa(content) 
                };
                // åªæœ‰æ–‡ä»¶å­˜åœ¨æ—¶æ‰ä¼ å…¥sha
                if (fileStatus.exists) {
                    requestBody.sha = fileStatus.sha;
                }

                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${GITHUB_TOKEN}`, 
                        'Accept': 'application/vnd.github.v3+json', 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || `HTTPé”™è¯¯: ${response.status}`);
                }
                // è¿”å›æ–°çš„shaå’Œæ–‡ä»¶å­˜åœ¨çŠ¶æ€
                return { success: true, sha: data.content.sha, exists: true };
            } catch (error) {
                logDebug(`å†™å…¥æ–‡ä»¶å¤±è´¥: ${error.message}`);
                return { success: false, message: error.message, sha: null, exists: false };
            }
        }

        // åˆ é™¤æ–‡ä»¶ - å…ˆæ£€æŸ¥æ–‡ä»¶çŠ¶æ€ç¡®ä¿shaæœ‰æ•ˆ
        async function deleteFile(path, commitMessage) {
            try {
                const fileStatus = await checkFileStatus(path);
                if (!fileStatus.exists) {
                    return { success: true, message: 'æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤' };
                }

                const response = await fetch(`${BASE_URL}/repos/${OWNER}/${REPO}/contents/${path}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `token ${GITHUB_TOKEN}`, 
                        'Accept': 'application/vnd.github.v3+json', 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ 
                        message: commitMessage, 
                        sha: fileStatus.sha 
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || `HTTPé”™è¯¯: ${response.status}`);
                }
                return { success: true, message: 'åˆ é™¤æˆåŠŸ' };
            } catch (error) {
                logDebug(`åˆ é™¤æ–‡ä»¶å¤±è´¥: ${error.message}`);
                return { success: false, message: error.message };
            }
        }

        // ========== ç®¡ç†å‘˜ç›¸å…³é€»è¾‘ ==========
        async function getAdminList() {
            if (cache.adminList.length > 0) return cache.adminList;
            logDebug(`é¦–æ¬¡è¯»å–ç®¡ç†å‘˜åˆ—è¡¨`);
            try {
                const fileData = await readFile(ADMIN_FILE_PATH);
                let adminList = fileData.content.split('\n')
                    .map(a => a.trim())
                    .filter(a => a);
                
                // ç¡®ä¿è¶…çº§ç®¡ç†å‘˜å§‹ç»ˆåœ¨åˆ—è¡¨ä¸­
                if (!adminList.includes(SUPER_ADMIN_USERNAME)) {
                    adminList.push(SUPER_ADMIN_USERNAME);
                    // åŒæ­¥å†™å…¥æ–‡ä»¶
                    await writeFile(ADMIN_FILE_PATH, adminList.join('\n'), 'ç¡®ä¿è¶…çº§ç®¡ç†å‘˜æƒé™');
                }
                cache.adminList = adminList;
                return adminList;
            } catch (error) {
                logDebug(`è¯»å–ç®¡ç†å‘˜åˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼: ${error.message}`);
                cache.adminList = [SUPER_ADMIN_USERNAME];
                return cache.adminList;
            }
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
        async function checkIsAdmin(username) {
            const adminList = await getAdminList();
            return adminList.includes(username);
        }

        // æ·»åŠ ç®¡ç†å‘˜
        async function addAdmin(targetUsername) {
            logDebug(`å°è¯•æ·»åŠ ç®¡ç†å‘˜: ${targetUsername}`);
            // æ£€æŸ¥ç›®æ ‡ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            const userFileStatus = await checkFileStatus(`users/${targetUsername}/Nickname.txt`);
            if (!userFileStatus.exists) {
                return { success: false, message: `âŒ ç”¨æˆ·ä¸å­˜åœ¨ï¼š${targetUsername}` };
            }
            // æ£€æŸ¥æ˜¯å¦å·²æ˜¯ç®¡ç†å‘˜
            const isAlreadyAdmin = await checkIsAdmin(targetUsername);
            if (isAlreadyAdmin) {
                return { success: false, message: `âŒ ${targetUsername} å·²æ˜¯ç®¡ç†å‘˜` };
            }
            // è·å–å¹¶æ›´æ–°ç®¡ç†å‘˜åˆ—è¡¨
            const adminList = await getAdminList();
            adminList.push(targetUsername);
            const uniqueAdminList = [...new Set(adminList)];
            // å†™å…¥æ–‡ä»¶
            const writeRes = await writeFile(
                ADMIN_FILE_PATH, 
                uniqueAdminList.join('\n'), 
                `Add admin: ${targetUsername} by ${loginUsername}`
            );
            if (writeRes.success) {
                cache.adminList = uniqueAdminList;
                return { success: true, message: `âœ… å·²å°† ${targetUsername} è®¾ç½®ä¸ºç®¡ç†å‘˜` };
            } else {
                return { success: false, message: `âŒ æ·»åŠ å¤±è´¥ï¼š${writeRes.message}` };
            }
        }

        // ========== ç”¨æˆ·ä¿¡æ¯è·å– ==========
        async function getUserNicknameAndLevel(username) {
            if (cache.userInfo[username]) return cache.userInfo[username];
            logDebug(`é¦–æ¬¡è·å–ç”¨æˆ·ä¿¡æ¯: ${username}`);
            try {
                const nicknameData = await readFile(`users/${username}/Nickname.txt`);
                const levelData = await readFile(`users/${username}/Level.txt`);
                const nickname = nicknameData.content.trim() || username;
                const level = levelData.content.trim() || '1';
                const isAdmin = await checkIsAdmin(username);
                const userInfo = { nickname, level, isAdmin };
                cache.userInfo[username] = userInfo;
                return userInfo;
            } catch (error) {
                logDebug(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼: ${error.message}`);
                const userInfo = { nickname: username, level: '1', isAdmin: false };
                cache.userInfo[username] = userInfo;
                return userInfo;
            }
        }

        // ========== æŒ‡ä»¤å¤„ç†é€»è¾‘ ==========
        const commandList = [
            { full: '/Help', short: '/H', desc: 'æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„æŒ‡ä»¤' },
            { full: '/Refresh', short: '/Rfr', desc: 'å¼ºåˆ¶åˆ·æ–°èŠå¤©è®°å½•ï¼ˆæ‰€æœ‰äººå¯ç”¨ï¼‰' },
            { full: '/clean', short: '/cls', desc: 'æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰' },
            { full: '/new_Administrator <ç”¨æˆ·å>', short: '/new_Admin <ç”¨æˆ·å>', desc: 'è®¾ç½®ç®¡ç†å‘˜ï¼ˆä»…Pu_caitå¯ç”¨ï¼‰' }
        ];

        async function parseCommand(commandStr) {
            const cmd = commandStr.trim().toLowerCase();
            // å¸®åŠ©æŒ‡ä»¤
            if (cmd === '/help' || cmd === '/h') {
                const commandHtml = commandList.map(item => 
                    `<div>â€¢ ${item.full} (${item.short})ï¼š${item.desc}</div>`
                ).join('');
                addSystemMessage(`
                    <div>ğŸ“‹ æ”¯æŒçš„æŒ‡ä»¤åˆ—è¡¨ï¼š</div>
                    <div class="command-list">${commandHtml}</div>
                `);
                return;
            }
            // åˆ·æ–°æŒ‡ä»¤
            if (cmd === '/refresh' || cmd === '/rfr') {
                await loadChatHistory(true);
                addSystemMessage('âœ… èŠå¤©è®°å½•å·²å¼ºåˆ¶åˆ·æ–°');
                return;
            }
            // æ¸…ç©ºæŒ‡ä»¤
            if (cmd === '/clean' || cmd === '/cls') {
                if (!isAdmin && loginUsername !== SUPER_ADMIN_USERNAME) {
                    addSystemMessage('âŒ æƒé™ä¸è¶³ï¼šä»…ç®¡ç†å‘˜å¯æ‰§è¡Œæ¸…ç©ºæ“ä½œ');
                    return;
                }
                if (!cache.chatFileExists) {
                    addSystemMessage('â„¹ï¸ èŠå¤©è®°å½•ä¸ºç©ºï¼Œæ— éœ€æ¸…ç©º');
                    return;
                }
                const delRes = await deleteFile(CHAT_CONTENT_PATH, `Clear chat by ${loginUsername}`);
                if (delRes.success) {
                    cache.chatHistory = [];
                    cache.chatSha = null;
                    cache.chatFileExists = false;
                    renderChatHistory(cache.chatHistory);
                    addSystemMessage('ğŸ—‘ï¸ èŠå¤©è®°å½•å·²æˆåŠŸæ¸…ç©º');
                } else {
                    addSystemMessage(`âŒ æ¸…ç©ºå¤±è´¥ï¼š${delRes.message}`);
                }
                return;
            }
            // æ·»åŠ ç®¡ç†å‘˜æŒ‡ä»¤
            if (cmd.startsWith('/new_administrator') || cmd.startsWith('/new_admin')) {
                if (loginUsername !== SUPER_ADMIN_USERNAME) {
                    addSystemMessage('âŒ æƒé™ä¸è¶³ï¼šä»…Pu_caitå¯è®¾ç½®ç®¡ç†å‘˜');
                    return;
                }
                const parts = commandStr.trim().split(' ');
                if (parts.length < 2) {
                    addSystemMessage('âŒ æŒ‡ä»¤æ ¼å¼é”™è¯¯ï¼š/new_Admin <ç”¨æˆ·å>');
                    return;
                }
                const targetUsername = parts[1].trim();
                const res = await addAdmin(targetUsername);
                addSystemMessage(res.message);
                return;
            }
            // æœªçŸ¥æŒ‡ä»¤
            addSystemMessage(`âŒ æœªçŸ¥æŒ‡ä»¤ï¼š${commandStr}ï¼ˆè¾“å…¥/HelpæŸ¥çœ‹æ‰€æœ‰æŒ‡ä»¤ï¼‰`);
        }

        // æ·»åŠ ç³»ç»Ÿæç¤ºæ¶ˆæ¯
        function addSystemMessage(content) {
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.innerHTML = content;
            chatMessagesEl.appendChild(systemMsg);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // ========== èŠå¤©æ ¸å¿ƒæ¸²æŸ“ä¸åŒæ­¥ ==========
        // æ¸²æŸ“èŠå¤©è®°å½•
        function renderChatHistory(messages) {
            chatMessagesEl.innerHTML = '';
            if (messages.length === 0) return;
            messages.forEach(async (msgLine) => {
                const firstSplit = msgLine.indexOf('|');
                const secondSplit = msgLine.indexOf(':', firstSplit + 1);
                if (firstSplit === -1 || secondSplit === -1) return;

                const senderUsername = msgLine.substring(0, firstSplit).trim();
                const timestamp = msgLine.substring(firstSplit + 1, secondSplit).trim();
                const msgContent = msgLine.substring(secondSplit + 1).trim();
                if (!senderUsername || !timestamp || !msgContent) return;

                const isSelf = senderUsername === loginUsername;
                // åˆ›å»ºæ¶ˆæ¯DOM
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${isSelf ? 'self' : 'other'}`;
                // ä¸´æ—¶å ä½å†…å®¹
                messageItem.innerHTML = `
                    <div class="sender">${senderUsername}<span class="level-badge">Lv.?</span></div>
                    <div class="content">${msgContent.replace(/\n/g, '<br>')}</div>
                    <div class="time">${formatTime(timestamp)}</div>
                `;
                chatMessagesEl.appendChild(messageItem);

                // å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯å¹¶æ›´æ–°
                const userInfo = await getUserNicknameAndLevel(senderUsername);
                const adminBadge = userInfo.isAdmin ? '<span class="admin-badge">ç®¡ç†å‘˜</span>' : '';
                messageItem.innerHTML = `
                    <div class="sender">${userInfo.nickname}<span class="level-badge">Lv.${userInfo.level}</span>${adminBadge}</div>
                    <div class="content">${msgContent.replace(/\n/g, '<br>')}</div>
                    <div class="time">${formatTime(timestamp)}</div>
                `;
            });
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // åŒæ­¥è¿œç¨‹èŠå¤©è®°å½•åˆ°æœ¬åœ°ç¼“å­˜
        async function syncRemoteChatHistory() {
            try {
                // å…ˆæ›´æ–°æ–‡ä»¶çŠ¶æ€
                const chatFileStatus = await checkFileStatus(CHAT_CONTENT_PATH);
                cache.chatFileExists = chatFileStatus.exists;
                cache.chatSha = chatFileStatus.sha;

                if (!cache.chatFileExists) {
                    cache.chatHistory = [];
                    renderChatHistory([]);
                    return;
                }

                // è¯»å–è¿œç¨‹å†…å®¹
                const fileData = await readFile(CHAT_CONTENT_PATH);
                const remoteChatHistory = fileData.content.split('\n').filter(line => line.trim());
                // åªæœ‰å†…å®¹ä¸ä¸€è‡´æ—¶æ‰æ›´æ–°æ¸²æŸ“
                if (JSON.stringify(remoteChatHistory) !== JSON.stringify(cache.chatHistory)) {
                    cache.chatHistory = remoteChatHistory;
                    cache.chatSha = fileData.sha;
                    renderChatHistory(cache.chatHistory);
                }
            } catch (error) {
                logDebug(`åŒæ­¥è¿œç¨‹èŠå¤©è®°å½•å¤±è´¥: ${error.message}`);
                // é™é»˜å¤±è´¥ï¼Œä¸å¹²æ‰°ç”¨æˆ·
            }
        }

        // åŠ è½½èŠå¤©è®°å½•
        async function loadChatHistory(isForce = false) {
            try {
                // éå¼ºåˆ¶åˆ·æ–°ä¸”æœ‰ç¼“å­˜ï¼Œç›´æ¥æ¸²æŸ“
                if (cache.chatHistory.length > 0 && !isForce) {
                    renderChatHistory(cache.chatHistory);
                    // åå°é™é»˜åŒæ­¥æœ€æ–°çŠ¶æ€
                    syncRemoteChatHistory();
                    return;
                }
                // å¼ºåˆ¶åˆ·æ–°æˆ–æ— ç¼“å­˜ï¼Œæ˜¾ç¤ºåŠ è½½å¹¶åŒæ­¥
                chatMessagesEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...</div>';
                await syncRemoteChatHistory();
            } catch (error) {
                logDebug(`åŠ è½½èŠå¤©è®°å½•å¤±è´¥: ${error.message}`);
                chatMessagesEl.innerHTML = `<div class="loading" style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼š${error.message}</div>`;
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const inputContent = messageInputEl.value.trim();
            if (!inputContent) {
                alert('è¯·è¾“å…¥èŠå¤©å†…å®¹');
                return;
            }
            sendMsgBtnEl.disabled = true;
            const timestamp = Date.now().toString();
            const newMsgLine = `${loginUsername}|${timestamp}:${inputContent}`;

            try {
                // æŒ‡ä»¤å¤„ç†
                if (inputContent.startsWith('/')) {
                    await parseCommand(inputContent);
                    messageInputEl.value = '';
                    sendMsgBtnEl.disabled = false;
                    return;
                }

                // æœ¬åœ°å…ˆæ¸²æŸ“ï¼ˆç§’å‘ä½“éªŒï¼‰
                const newChatHistory = [...cache.chatHistory, newMsgLine];
                cache.chatHistory = newChatHistory;
                renderChatHistory(newChatHistory);
                messageInputEl.value = ''; // ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†

                // æ‹¼æ¥æ–°å†…å®¹
                const newContent = newChatHistory.join('\n');
                // å†™å…¥è¿œç¨‹æ–‡ä»¶ï¼ˆè‡ªåŠ¨å¤„ç†shaï¼‰
                const writeRes = await writeFile(
                    CHAT_CONTENT_PATH,
                    newContent,
                    `Chat message from ${loginUsername} at ${formatTime(timestamp)}`
                );

                // æ›´æ–°ç¼“å­˜çŠ¶æ€
                if (writeRes.success) {
                    cache.chatSha = writeRes.sha;
                    cache.chatFileExists = writeRes.exists;
                } else {
                    // å†™å…¥å¤±è´¥ï¼Œå›æ»šæœ¬åœ°ç¼“å­˜
                    cache.chatHistory = cache.chatHistory.slice(0, -1);
                    renderChatHistory(cache.chatHistory);
                    addSystemMessage(`âŒ æ¶ˆæ¯å‘é€å¤±è´¥ï¼š${writeRes.message}`);
                }
            } catch (error) {
                logDebug(`å‘é€æ¶ˆæ¯å¼‚å¸¸: ${error.message}`);
                // å¼‚å¸¸å›æ»š
                cache.chatHistory = cache.chatHistory.slice(0, -1);
                renderChatHistory(cache.chatHistory);
                addSystemMessage(`âŒ æ¶ˆæ¯å‘é€å¼‚å¸¸ï¼š${error.message}`);
            } finally {
                sendMsgBtnEl.disabled = false;
            }
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        async function init() {
            try {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const userStr = localStorage.getItem('caitlab_currentUser');
                if (!userStr) throw new Error('æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•');
                currentUser = JSON.parse(userStr);
                loginUsername = currentUser.username;
                loginNickname = currentUser.nickname || currentUser.username;
                loginLevel = currentUser.level || '1';

                // æ£€æŸ¥ç®¡ç†å‘˜èº«ä»½
                isAdmin = await checkIsAdmin(loginUsername);
                // ç¼“å­˜å½“å‰ç”¨æˆ·ä¿¡æ¯
                cache.userInfo[loginUsername] = { nickname: loginNickname, level: loginLevel, isAdmin };

                // æ›´æ–°é¡µé¢å¤´éƒ¨
                loginNicknameEl.textContent = loginNickname;
                loginLevelEl.textContent = `Lv.${loginLevel}`;
                if (isAdmin) loginAdminBadgeEl.style.display = 'inline-block';

                // åŠ è½½èŠå¤©è®°å½•
                await loadChatHistory();
                // ç»‘å®šäº‹ä»¶
                bindEvent();
                // å¯åŠ¨è‡ªåŠ¨åŒæ­¥å®šæ—¶å™¨
                startSyncTimer();

            } catch (err) {
                loginNicknameEl.textContent = 'æœªç™»å½•';
                loginLevelEl.style.display = 'none';
                sendMsgBtnEl.disabled = true;
                chatMessagesEl.innerHTML = `<div class="loading" style="color: #dc3545;">${err.message}</div>`;
                alert(`ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼š${err.message}`);
                setTimeout(() => window.location.href = '../auth/login/index.html', 2000);
            }
        }

        // ç»‘å®šé¡µé¢äº‹ä»¶
        function bindEvent() {
            // å‘é€æŒ‰é’®ç‚¹å‡»
            sendMsgBtnEl.addEventListener('click', sendMessage);
            // å›è½¦å‘é€ï¼ˆshift+å›è½¦æ¢è¡Œï¼‰
            messageInputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
            window.addEventListener('beforeunload', () => {
                if (syncTimer) clearInterval(syncTimer);
            });
        }

        // å¯åŠ¨è‡ªåŠ¨åŒæ­¥å®šæ—¶å™¨
        function startSyncTimer() {
            if (syncTimer) clearInterval(syncTimer);
            syncTimer = setInterval(() => {
                // è¾“å…¥æ¡†æœªèšç„¦ä¸”æœªåœ¨å‘é€ä¸­ï¼Œæ‰åŒæ­¥
                if (document.activeElement !== messageInputEl && !sendMsgBtnEl.disabled) {
                    syncRemoteChatHistory();
                }
            }, SYNC_INTERVAL);
            logDebug(`è‡ªåŠ¨åŒæ­¥å®šæ—¶å™¨å·²å¯åŠ¨ï¼Œé—´éš”${SYNC_INTERVAL/1000}ç§’`);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>
